"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.provideLinter = exports.cliExec = exports.execEslint = exports.execPrettier = exports.getValidFilePaths = exports.getPathToPrettier = exports.getPathToESLint = exports.getCurrentFilePath = exports.run = exports.serialize = exports.activate = exports.config = void 0;
const child_process_1 = require("child_process");
const config_js_1 = __importDefault(require("./config.js"));
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const atom_linter_1 = require("atom-linter");
const eslint_1 = __importDefault(require("eslint"));
const cliEngine = new eslint_1.default.ESLint({});
function bytes2String(bytes) {
    let result = "";
    for (let i = 0; i < bytes.length; i++) {
        result += String.fromCharCode(bytes[i]);
    }
    return result;
}
exports.config = config_js_1.default;
let next_ready = false;
let start_time = Date.now();
async function waitToReady() {
    async function checkReady() {
        if (!(next_ready || Date.now() > start_time + 300000)) {
            await window.setTimeout(checkReady, 1000);
        }
        else {
        }
    }
    logNotification("OWOWOWOW wait");
    await checkReady();
    logNotification("OWOWOWOW done");
    return [];
}
let current_results = new Promise(() => {
    logNotification("OWOWOWOW linaaaaaat");
    waitToReady();
    return [];
});
const current_config = exports.config;
let running = false;
let child = null;
function logNotification(text, tittle = "-- DEBUG --") {
    const args = { dismissable: tittle === "-- DEBUG --", detail: text };
    atom.notifications.addInfo(tittle, args);
}
function activate() {
    atom.commands.add("atom-workspace", {
        "auto-prettier-eslint:run": () => {
            run();
        },
    });
    atom.workspace.observeTextEditors((editor) => {
        editor.onDidSave(() => {
            atom.notifications.clear();
            const files = getValidFilePaths(current_config.prettierFileType.get(), getCurrentFilePath());
            if (files.length === 0)
                return;
            if (running && child) {
                child.kill();
                running = false;
            }
            if (!running) {
                if (current_config.notifications.get()) {
                    logNotification("", "Running auto-prettier-eslint");
                }
                running = true;
                run();
            }
        });
    });
}
exports.activate = activate;
function serialize() { }
exports.serialize = serialize;
function run() {
    execPrettier(getCurrentFilePath());
}
exports.run = run;
function getCurrentWorkingDir(filepath) {
    let cwd;
    atom.project.getDirectories().forEach(function (dir) {
        const dirpath = dir.getPath();
        const relpath = path_1.default.relative(dirpath, filepath);
        const dirIsParent = !/^\.\.\//.test(relpath);
        if (dirIsParent) {
            cwd = dirpath;
        }
    });
    cwd = cwd || process.cwd();
    return cwd;
}
function getCurrentFilePath() {
    return atom.workspace.getActivePaneItem().getPath();
}
exports.getCurrentFilePath = getCurrentFilePath;
function getPathToESLint(cwd) {
    if (current_config.eslintPath.get()) {
        return current_config.eslintPath.get();
    }
    if (fs_1.default.existsSync(`${cwd}/node_modules/.bin/eslint`)) {
        return "./node_modules/.bin/eslint";
    }
    return "eslint";
}
exports.getPathToESLint = getPathToESLint;
function getPathToPrettier(cwd) {
    if (current_config.prettierPath.get()) {
        return current_config.prettierPath.get();
    }
    if (fs_1.default.existsSync(`${cwd}/node_modules/.bin/prettier`)) {
        return "./node_modules/.bin/prettier";
    }
    return "prettier";
}
exports.getPathToPrettier = getPathToPrettier;
function getValidFilePaths(fileType, filepath) {
    const files = [];
    const paths = filepath instanceof Array ? filepath.slice() : [filepath];
    const rex = new RegExp("\\.(" + fileType.replace(/\s*,\s*/g, "|") + ")$");
    for (let i = 0; i < paths.length; ++i) {
        if (rex.test(paths[i])) {
            files.push(paths[i]);
        }
    }
    return files;
}
exports.getValidFilePaths = getValidFilePaths;
function execPrettier(filepath) {
    const args = getValidFilePaths(current_config.prettierFileType.get(), filepath);
    if (args.length === 0) {
        running = false;
        return;
    }
    args.unshift("-w");
    args.unshift("--cache");
    const cwd = getCurrentWorkingDir(filepath);
    const runner = getPathToPrettier(cwd);
    cliExec(cwd, runner, args, () => {
        execEslint(filepath);
    });
}
exports.execPrettier = execPrettier;
function execEslint(filepath) {
    const args = getValidFilePaths(current_config.eslintFileType.get(), filepath);
    if (args.length === 0) {
        running = false;
        return;
    }
    args.unshift("--fix");
    args.unshift("--cache");
    args.unshift("--no-ignore");
    args.unshift("--format=unix");
    const cwd = getCurrentWorkingDir(filepath);
    const runner = getPathToESLint(cwd);
    cliExec(cwd, runner, args, () => { });
}
exports.execEslint = execEslint;
function cliExec(cwd, runner, arg, callback) {
    if (runner.includes("eslint")) {
        const file = arg[arg.length - 1];
    }
    child = (0, child_process_1.execFile)(runner, arg, { cwd, shell: false }, (error, stdout, stderr) => {
        const out = stdout;
        const err = stderr;
        const args = { detail: err ? err + "\n" + out : out, dismissable: false };
        const notif = error ? current_config.zerror.get() : current_config.ysuccess.get();
        if (current_config.notifications.get()) {
            logNotification("", runner + " compleated");
        }
        if (runner.includes("eslint")) {
            current_results.then((results) => {
                logNotification("OWOWOWOW");
                let parsing = out;
                const messages = [];
                let file_path = "";
                while (parsing.length > 0 && parsing.indexOf("\n") !== 0) {
                    const fileAndWhere = parsing.substring(0, parsing.indexOf(" "));
                    parsing = parsing.substring(parsing.indexOf(" "));
                    const message = parsing.substring(0, parsing.indexOf("\n"));
                    parsing = parsing.substring(parsing.indexOf("\n"));
                    const [fp, line, column, _] = fileAndWhere.split(":");
                    file_path = fp;
                    messages.push({
                        message: message,
                        line: Number(column) - 1,
                        column: Number(line) - 1,
                        ruleId: null,
                    });
                }
                results.push({
                    filePath: file_path,
                    messages: messages,
                    errorCount: messages.length,
                    fatalErrorCount: 0,
                    warningCount: 0,
                    fixableErrorCount: 0,
                    fixableWarningCount: 0,
                });
                return results;
            });
            next_ready = true;
        }
        running = false;
        child = null;
        callback();
        if (notif.type === "none") {
            return;
        }
        else if (notif.type === "dismissable" && err.length + out.length > 0) {
            args.dismissable = true;
        }
        if (error) {
            atom.notifications.addError(runner + " failed", args);
        }
        else {
            atom.notifications.addSuccess(runner + " successful", args);
        }
    });
}
exports.cliExec = cliExec;
function provideLinter() {
    return {
        name: "Eslint",
        grammarScopes: ["source.ts"],
        scope: "file",
        lintsOnChange: false,
        lint: async (editor) => {
            logNotification("OWOWOWOW async");
            next_ready = false;
            start_time = Date.now();
            current_results.then(async (result) => {
                logNotification("OWOWOWOW lint");
                await waitToReady();
                return result;
            });
            return await current_results
                .then((results) => {
                logNotification("OWOWOWOW then");
                const promises = [];
                for (let i = 0; i < results.length; ++i) {
                    for (let j = 0; j < results[i].messages.length; ++j) {
                        promises.push({
                            severity: "error",
                            excerpt: results[i].messages[j].message,
                            location: {
                                file: results[i].filePath,
                                position: (0, atom_linter_1.generateRange)(editor, results[i].messages[j].line, results[i].messages[j].column),
                            },
                        });
                    }
                }
                current_results = new Promise(() => {
                    logNotification("OWOWOWOW qqqqqq");
                    return [];
                });
                return promises;
            })
                .catch((error) => {
                logNotification("", "ERROR: " + error.message);
            });
        },
    };
}
exports.provideLinter = provideLinter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0by1wcmV0dGllci1lc2xpbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvYXV0by1wcmV0dGllci1lc2xpbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7Ozs7QUFFYixpREFBeUM7QUFDekMsNERBQWlDO0FBQ2pDLGdEQUF3QjtBQUN4Qiw0Q0FBb0I7QUFDcEIsNkNBQTRDO0FBRTVDLG9EQUE0QjtBQUU1QixNQUFNLFNBQVMsR0FBa0IsSUFBSSxnQkFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUV2RCxTQUFTLFlBQVksQ0FBQyxLQUFLO0lBQ3pCLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztJQUNoQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3RDLE1BQU0sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFDRCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDO0FBRVksUUFBQSxNQUFNLEdBQUcsbUJBQU0sQ0FBQztBQUM3QixJQUFJLFVBQVUsR0FBRyxLQUFLLENBQUM7QUFDdkIsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBRTVCLEtBQUssVUFBVSxXQUFXO0lBQ3hCLEtBQUssVUFBVSxVQUFVO1FBQ3ZCLElBQUksQ0FBQyxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsVUFBVSxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDdEQsTUFBTSxNQUFNLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM1QyxDQUFDO2FBQU0sQ0FBQztRQUNSLENBQUM7SUFDSCxDQUFDO0lBRUQsZUFBZSxDQUFDLGVBQWUsQ0FBQyxD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WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IHsgZXhlY0ZpbGUgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xuaW1wb3J0IENvbmZpZyBmcm9tIFwiLi9jb25maWcuanNcIjtcbmltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgeyBnZW5lcmF0ZVJhbmdlIH0gZnJvbSBcImF0b20tbGludGVyXCI7XG5pbXBvcnQgeyBMaW50UmVzdWx0LCBMaW50TWVzc2FnZSB9IGZyb20gXCIuL0VTbGludFR5cGVzLmQuanNcIjtcbmltcG9ydCBFU0xpbnQgZnJvbSBcImVzbGludFwiO1xuXG5jb25zdCBjbGlFbmdpbmU6IEVTTGludC5FU0xpbnQgPSBuZXcgRVNMaW50LkVTTGludCh7fSk7XG5cbmZ1bmN0aW9uIGJ5dGVzMlN0cmluZyhieXRlcykge1xuICBsZXQgcmVzdWx0ID0gXCJcIjtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBieXRlcy5sZW5ndGg7IGkrKykge1xuICAgIHJlc3VsdCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ5dGVzW2ldKTtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgY29uc3QgY29uZmlnID0gQ29uZmlnO1xubGV0IG5leHRfcmVhZHkgPSBmYWxzZTtcbmxldCBzdGFydF90aW1lID0gRGF0ZS5ub3coKTtcblxuYXN5bmMgZnVuY3Rpb24gd2FpdFRvUmVhZHkoKSB7XG4gIGFzeW5jIGZ1bmN0aW9uIGNoZWNrUmVhZHkoKSB7XG4gICAgaWYgKCEobmV4dF9yZWFkeSB8fCBEYXRlLm5vdygpID4gc3RhcnRfdGltZSArIDMwMDAwMCkpIHtcbiAgICAgIGF3YWl0IHdpbmRvdy5zZXRUaW1lb3V0KGNoZWNrUmVhZHksIDEwMDApO1xuICAgIH0gZWxzZSB7XG4gICAgfVxuICB9XG5cbiAgbG9nTm90aWZpY2F0aW9uKFwiT1dPV09XT1cgd2FpdFwiKTtcbiAgYXdhaXQgY2hlY2tSZWFkeSgpO1xuICBsb2dOb3RpZmljYXRpb24oXCJPV09XT1dPVyBkb25lXCIpO1xuICByZXR1cm4gW107XG59XG5cbmxldCBjdXJyZW50X3Jlc3VsdHM6IFByb21pc2U8TGludFJlc3VsdFtdPiA9IG5ldyBQcm9taXNlKCgpID0+IHtcbiAgbG9nTm90aWZpY2F0aW9uKFwiT1dPV09XT1cgbGluYWFhYWFhdFwiKTtcbiAgd2FpdFRvUmVhZHkoKTtcbiAgcmV0dXJuIFtdO1xufSk7XG5jb25zdCBjdXJyZW50X2NvbmZpZyA9IGNvbmZpZztcbmxldCBydW5uaW5nID0gZmFsc2U7XG5sZXQgY2hpbGQgPSBudWxsO1xuXG5mdW5jdGlvbiBsb2dOb3RpZmljYXRpb24odGV4dCwgdGl0dGxlID0gXCItLSBERUJVRyAtLVwiKSB7XG4gIGNvbnN0IGFyZ3MgPSB7IGRpc21pc3NhYmxlOiB0aXR0bGUgPT09IFwiLS0gREVCVUcgLS1cIiwgZGV0YWlsOiB0ZXh0IH07XG4gIGF0b20ubm90aWZpY2F0aW9ucy5hZGRJbmZvKHRpdHRsZSwgYXJncyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZSgpIHtcbiAgYXRvbS5jb21tYW5kcy5hZGQoXCJhdG9tLXdvcmtzcGFjZVwiLCB7XG4gICAgXCJhdXRvLXByZXR0aWVyLWVzbGludDpydW5cIjogKCkgPT4ge1xuICAgICAgcnVuKCk7XG4gICAgfSxcbiAgfSk7XG5cbiAgYXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZVRleHRFZGl0b3JzKChlZGl0b3IpID0+IHtcbiAgICBlZGl0b3Iub25EaWRTYXZlKCgpID0+IHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5jbGVhcigpO1xuICAgICAgY29uc3QgZmlsZXMgPSBnZXRWYWxpZEZpbGVQYXRocyhjdXJyZW50X2NvbmZpZy5wcmV0dGllckZpbGVUeXBlLmdldCgpLCBnZXRDdXJyZW50RmlsZVBhdGgoKSk7XG4gICAgICBpZiAoZmlsZXMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICBpZiAocnVubmluZyAmJiBjaGlsZCkge1xuICAgICAgICBjaGlsZC5raWxsKCk7XG4gICAgICAgIHJ1bm5pbmcgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmICghcnVubmluZykge1xuICAgICAgICBpZiAoY3VycmVudF9jb25maWcubm90aWZpY2F0aW9ucy5nZXQoKSkge1xuICAgICAgICAgIGxvZ05vdGlmaWNhdGlvbihcIlwiLCBcIlJ1bm5pbmcgYXV0by1wcmV0dGllci1lc2xpbnRcIik7XG4gICAgICAgIH1cbiAgICAgICAgcnVubmluZyA9IHRydWU7XG4gICAgICAgIHJ1bigpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlcmlhbGl6ZSgpIHt9XG5cbmV4cG9ydCBmdW5jdGlvbiBydW4oKSB7XG4gIGV4ZWNQcmV0dGllcihnZXRDdXJyZW50RmlsZVBhdGgoKSk7XG59XG5cbmZ1bmN0aW9uIGdldEN1cnJlbnRXb3JraW5nRGlyKGZpbGVwYXRoKSB7XG4gIGxldCBjd2Q7XG4gIGF0b20ucHJvamVjdC5nZXREaXJlY3RvcmllcygpLmZvckVhY2goZnVuY3Rpb24gKGRpcikge1xuICAgIGNvbnN0IGRpcnBhdGggPSBkaXIuZ2V0UGF0aCgpO1xuICAgIGNvbnN0IHJlbHBhdGggPSBwYXRoLnJlbGF0aXZlKGRpcnBhdGgsIGZpbGVwYXRoKTtcbiAgICBjb25zdCBkaXJJc1BhcmVudCA9ICEvXlxcLlxcLlxcLy8udGVzdChyZWxwYXRoKTtcbiAgICBpZiAoZGlySXNQYXJlbnQpIHtcbiAgICAgIGN3ZCA9IGRpcnBhdGg7XG4gICAgfVxuICB9KTtcbiAgY3dkID0gY3dkIHx8IHByb2Nlc3MuY3dkKCk7XG4gIHJldHVybiBjd2Q7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDdXJyZW50RmlsZVBhdGgoKSB7XG4gIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgcmV0dXJuIGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVBhbmVJdGVtKCkuZ2V0UGF0aCgpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGF0aFRvRVNMaW50KGN3ZCkge1xuICBpZiAoY3VycmVudF9jb25maWcuZXNsaW50UGF0aC5nZXQoKSkge1xuICAgIHJldHVybiBjdXJyZW50X2NvbmZpZy5lc2xpbnRQYXRoLmdldCgpO1xuICB9XG4gIGlmIChmcy5leGlzdHNTeW5jKGAke2N3ZH0vbm9kZV9tb2R1bGVzLy5iaW4vZXNsaW50YCkpIHtcbiAgICByZXR1cm4gXCIuL25vZGVfbW9kdWxlcy8uYmluL2VzbGludFwiO1xuICB9XG4gIHJldHVybiBcImVzbGludFwiO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGF0aFRvUHJldHRpZXIoY3dkKSB7XG4gIGlmIChjdXJyZW50X2NvbmZpZy5wcmV0dGllclBhdGguZ2V0KCkpIHtcbiAgICByZXR1cm4gY3VycmVudF9jb25maWcucHJldHRpZXJQYXRoLmdldCgpO1xuICB9XG4gIGlmIChmcy5leGlzdHNTeW5jKGAke2N3ZH0vbm9kZV9tb2R1bGVzLy5iaW4vcHJldHRpZXJgKSkge1xuICAgIHJldHVybiBcIi4vbm9kZV9tb2R1bGVzLy5iaW4vcHJldHRpZXJcIjtcbiAgfVxuICByZXR1cm4gXCJwcmV0dGllclwiO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VmFsaWRGaWxlUGF0aHMoZmlsZVR5cGUsIGZpbGVwYXRoKSB7XG4gIGNvbnN0IGZpbGVzID0gW107XG4gIGNvbnN0IHBhdGhzID0gZmlsZXBhdGggaW5zdGFuY2VvZiBBcnJheSA/IGZpbGVwYXRoLnNsaWNlKCkgOiBbZmlsZXBhdGhdO1xuICBjb25zdCByZXggPSBuZXcgUmVnRXhwKFwiXFxcXC4oXCIgKyBmaWxlVHlwZS5yZXBsYWNlKC9cXHMqLFxccyovZywgXCJ8XCIpICsgXCIpJFwiKTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXRocy5sZW5ndGg7ICsraSkge1xuICAgIGlmIChyZXgudGVzdChwYXRoc1tpXSkpIHtcbiAgICAgIGZpbGVzLnB1c2gocGF0aHNbaV0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmlsZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBleGVjUHJldHRpZXIoZmlsZXBhdGgpIHtcbiAgY29uc3QgYXJncyA9IGdldFZhbGlkRmlsZVBhdGhzKGN1cnJlbnRfY29uZmlnLnByZXR0aWVyRmlsZVR5cGUuZ2V0KCksIGZpbGVwYXRoKTtcbiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgcnVubmluZyA9IGZhbHNlO1xuICAgIHJldHVybjtcbiAgfVxuICBhcmdzLnVuc2hpZnQoXCItd1wiKTtcbiAgYXJncy51bnNoaWZ0KFwiLS1jYWNoZVwiKTtcbiAgY29uc3QgY3dkID0gZ2V0Q3VycmVudFdvcmtpbmdEaXIoZmlsZXBhdGgpO1xuICBjb25zdCBydW5uZXIgPSBnZXRQYXRoVG9QcmV0dGllcihjd2QpO1xuICBjbGlFeGVjKGN3ZCwgcnVubmVyLCBhcmdzLCAoKSA9PiB7XG4gICAgZXhlY0VzbGludChmaWxlcGF0aCk7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXhlY0VzbGludChmaWxlcGF0aCkge1xuICBjb25zdCBhcmdzID0gZ2V0VmFsaWRGaWxlUGF0aHMoY3VycmVudF9jb25maWcuZXNsaW50RmlsZVR5cGUuZ2V0KCksIGZpbGVwYXRoKTtcbiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgcnVubmluZyA9IGZhbHNlO1xuICAgIHJldHVybjtcbiAgfVxuICBhcmdzLnVuc2hpZnQoXCItLWZpeFwiKTtcbiAgYXJncy51bnNoaWZ0KFwiLS1jYWNoZVwiKTtcbiAgYXJncy51bnNoaWZ0KFwiLS1uby1pZ25vcmVcIik7XG4gIGFyZ3MudW5zaGlmdChcIi0tZm9ybWF0PXVuaXhcIik7XG5cbiAgY29uc3QgY3dkID0gZ2V0Q3VycmVudFdvcmtpbmdEaXIoZmlsZXBhdGgpO1xuICBjb25zdCBydW5uZXIgPSBnZXRQYXRoVG9FU0xpbnQoY3dkKTtcbiAgY2xpRXhlYyhjd2QsIHJ1bm5lciwgYXJncywgKCkgPT4ge30pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2xpRXhlYyhjd2QsIHJ1bm5lciwgYXJnLCBjYWxsYmFjaykge1xuICBpZiAocnVubmVyLmluY2x1ZGVzKFwiZXNsaW50XCIpKSB7XG4gICAgY29uc3QgZmlsZSA9IGFyZ1thcmcubGVuZ3RoIC0gMV07XG4gICAgLy8gY3VycmVudF9yZXN1bHRzXG4gICAgLy8gICAudGhlbihhc3luYyAocmVzdWx0KSA9PiB7XG4gICAgLy8gICAgIGNvbnN0IHJlc3VsdDIgPSBhd2FpdCBjbGlFbmdpbmUubGludEZpbGVzKGZpbGUpO1xuICAgIC8vICAgICByZXR1cm4gcmVzdWx0LmNvbmNhdChyZXN1bHQyKTtcbiAgICAvLyAgIH0pXG4gICAgLy8gICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgLy8gICAgIGxvZ05vdGlmaWNhdGlvbihcIlwiLCBcIkVycm9yOiBcIiArIFN0cmluZyhlcnJvcikpO1xuICAgIC8vICAgICByZXR1cm4gW107XG4gICAgLy8gICB9KTtcbiAgfVxuXG4gIGNoaWxkID0gZXhlY0ZpbGUocnVubmVyLCBhcmcsIHsgY3dkLCBzaGVsbDogZmFsc2UgfSwgKGVycm9yLCBzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgIGNvbnN0IG91dCA9IHN0ZG91dDtcbiAgICBjb25zdCBlcnIgPSBzdGRlcnI7XG4gICAgY29uc3QgYXJncyA9IHsgZGV0YWlsOiBlcnIgPyBlcnIgKyBcIlxcblwiICsgb3V0IDogb3V0LCBkaXNtaXNzYWJsZTogZmFsc2UgfTtcbiAgICBjb25zdCBub3RpZiA9IGVycm9yID8gY3VycmVudF9jb25maWcuemVycm9yLmdldCgpIDogY3VycmVudF9jb25maWcueXN1Y2Nlc3MuZ2V0KCk7XG4gICAgaWYgKGN1cnJlbnRfY29uZmlnLm5vdGlmaWNhdGlvbnMuZ2V0KCkpIHtcbiAgICAgIGxvZ05vdGlmaWNhdGlvbihcIlwiLCBydW5uZXIgKyBcIiBjb21wbGVhdGVkXCIpO1xuICAgIH1cbiAgICBpZiAocnVubmVyLmluY2x1ZGVzKFwiZXNsaW50XCIpKSB7XG4gICAgICBjdXJyZW50X3Jlc3VsdHMudGhlbigocmVzdWx0cykgPT4ge1xuICAgICAgICBsb2dOb3RpZmljYXRpb24oXCJPV09XT1dPV1wiKTtcbiAgICAgICAgbGV0IHBhcnNpbmcgPSBvdXQ7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2VzOiBMaW50TWVzc2FnZVtdID0gW107XG4gICAgICAgIGxldCBmaWxlX3BhdGggPSBcIlwiO1xuICAgICAgICB3aGlsZSAocGFyc2luZy5sZW5ndGggPiAwICYmIHBhcnNpbmcuaW5kZXhPZihcIlxcblwiKSAhPT0gMCkge1xuICAgICAgICAgIGNvbnN0IGZpbGVBbmRXaGVyZSA9IHBhcnNpbmcuc3Vic3RyaW5nKDAsIHBhcnNpbmcuaW5kZXhPZihcIiBcIikpO1xuICAgICAgICAgIHBhcnNpbmcgPSBwYXJzaW5nLnN1YnN0cmluZyhwYXJzaW5nLmluZGV4T2YoXCIgXCIpKTtcblxuICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBwYXJzaW5nLnN1YnN0cmluZygwLCBwYXJzaW5nLmluZGV4T2YoXCJcXG5cIikpO1xuICAgICAgICAgIHBhcnNpbmcgPSBwYXJzaW5nLnN1YnN0cmluZyhwYXJzaW5nLmluZGV4T2YoXCJcXG5cIikpO1xuXG4gICAgICAgICAgY29uc3QgW2ZwLCBsaW5lLCBjb2x1bW4sIF9dID0gZmlsZUFuZFdoZXJlLnNwbGl0KFwiOlwiKTtcbiAgICAgICAgICBmaWxlX3BhdGggPSBmcDtcbiAgICAgICAgICBtZXNzYWdlcy5wdXNoKHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXG4gICAgICAgICAgICBsaW5lOiBOdW1iZXIoY29sdW1uKSAtIDEsXG4gICAgICAgICAgICBjb2x1bW46IE51bWJlcihsaW5lKSAtIDEsXG4gICAgICAgICAgICBydWxlSWQ6IG51bGwsXG4gICAgICAgICAgfSBhcyBMaW50TWVzc2FnZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzdWx0cy5wdXNoKHtcbiAgICAgICAgICBmaWxlUGF0aDogZmlsZV9wYXRoLFxuICAgICAgICAgIG1lc3NhZ2VzOiBtZXNzYWdlcyxcbiAgICAgICAgICBlcnJvckNvdW50OiBtZXNzYWdlcy5sZW5ndGgsXG4gICAgICAgICAgZmF0YWxFcnJvckNvdW50OiAwLFxuICAgICAgICAgIHdhcm5pbmdDb3VudDogMCxcbiAgICAgICAgICBmaXhhYmxlRXJyb3JDb3VudDogMCxcbiAgICAgICAgICBmaXhhYmxlV2FybmluZ0NvdW50OiAwLFxuICAgICAgICB9IGFzIExpbnRSZXN1bHQpO1xuICAgICAgICByZXR1cm4gcmVzdWx0cztcbiAgICAgIH0pO1xuICAgICAgbmV4dF9yZWFkeSA9IHRydWU7XG4gICAgfVxuICAgIHJ1bm5pbmcgPSBmYWxzZTtcbiAgICBjaGlsZCA9IG51bGw7XG4gICAgY2FsbGJhY2soKTtcbiAgICAvLyBub3RpZmljYXRpb25zIGhhbmRsZVxuICAgIGlmIChub3RpZi50eXBlID09PSBcIm5vbmVcIikge1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSBpZiAobm90aWYudHlwZSA9PT0gXCJkaXNtaXNzYWJsZVwiICYmIGVyci5sZW5ndGggKyBvdXQubGVuZ3RoID4gMCkge1xuICAgICAgYXJncy5kaXNtaXNzYWJsZSA9IHRydWU7XG4gICAgfVxuICAgIGlmIChlcnJvcikge1xuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKHJ1bm5lciArIFwiIGZhaWxlZFwiLCBhcmdzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFN1Y2Nlc3MocnVubmVyICsgXCIgc3VjY2Vzc2Z1bFwiLCBhcmdzKTtcbiAgICB9XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvdmlkZUxpbnRlcigpIHtcbiAgcmV0dXJuIHtcbiAgICBuYW1lOiBcIkVzbGludFwiLFxuICAgIGdyYW1tYXJTY29wZXM6IFtcInNvdXJjZS50c1wiXSxcbiAgICBzY29wZTogXCJmaWxlXCIsXG4gICAgbGludHNPbkNoYW5nZTogZmFsc2UsXG4gICAgbGludDogYXN5bmMgKGVkaXRvcikgPT4ge1xuICAgICAgbG9nTm90aWZpY2F0aW9uKFwiT1dPV09XT1cgYXN5bmNcIik7XG4gICAgICBuZXh0X3JlYWR5ID0gZmFsc2U7XG4gICAgICBzdGFydF90aW1lID0gRGF0ZS5ub3coKTtcbiAgICAgIGN1cnJlbnRfcmVzdWx0cy50aGVuKGFzeW5jIChyZXN1bHQpID0+IHtcbiAgICAgICAgbG9nTm90aWZpY2F0aW9uKFwiT1dPV09XT1cgbGludFwiKTtcbiAgICAgICAgYXdhaXQgd2FpdFRvUmVhZHkoKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGF3YWl0IGN1cnJlbnRfcmVzdWx0c1xuICAgICAgICAudGhlbigocmVzdWx0cykgPT4ge1xuICAgICAgICAgIGxvZ05vdGlmaWNhdGlvbihcIk9XT1dPV09XIHRoZW5cIik7XG4gICAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBbXTtcbiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdHMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVzdWx0c1tpXS5tZXNzYWdlcy5sZW5ndGg7ICsraikge1xuICAgICAgICAgICAgICBwcm9taXNlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICBzZXZlcml0eTogXCJlcnJvclwiLCAvLyByZXN1bHRzW2ldLm1lc3NhZ2VzW2pdLnNldmVyaXR5LFxuICAgICAgICAgICAgICAgIGV4Y2VycHQ6IHJlc3VsdHNbaV0ubWVzc2FnZXNbal0ubWVzc2FnZSxcbiAgICAgICAgICAgICAgICBsb2NhdGlvbjoge1xuICAgICAgICAgICAgICAgICAgZmlsZTogcmVzdWx0c1tpXS5maWxlUGF0aCxcbiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBnZW5lcmF0ZVJhbmdlKGVkaXRvciwgcmVzdWx0c1tpXS5tZXNzYWdlc1tqXS5saW5lLCByZXN1bHRzW2ldLm1lc3NhZ2VzW2pdLmNvbHVtbiksXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGN1cnJlbnRfcmVzdWx0cyA9IG5ldyBQcm9taXNlKCgpID0+IHtcbiAgICAgICAgICAgIGxvZ05vdGlmaWNhdGlvbihcIk9XT1dPV09XIHFxcXFxcVwiKTtcbiAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZXR1cm4gcHJvbWlzZXM7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaCgoZXJyb3I6IEVycm9yKSA9PiB7XG4gICAgICAgICAgbG9nTm90aWZpY2F0aW9uKFwiXCIsIFwiRVJST1I6IFwiICsgZXJyb3IubWVzc2FnZSk7XG4gICAgICAgIH0pO1xuICAgIH0sXG4gIH07XG59XG4iXX0=