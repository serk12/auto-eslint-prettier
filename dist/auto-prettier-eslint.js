"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.provideLinter = exports.cliExec = exports.execEslint = exports.execPrettier = exports.getValidFilePaths = exports.getPathToPrettier = exports.getPathToESLint = exports.getCurrentFilePath = exports.run = exports.serialize = exports.activate = exports.config = void 0;
const child_process_1 = require("child_process");
const config_js_1 = __importDefault(require("./config.js"));
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const atom_linter_1 = require("atom-linter");
const eslint_1 = __importDefault(require("eslint"));
const cliEngine = new eslint_1.default.ESLint({});
function bytes2String(bytes) {
    let result = "";
    for (let i = 0; i < bytes.length; i++) {
        result += String.fromCharCode(bytes[i]);
    }
    return result;
}
exports.config = config_js_1.default;
let next_ready = false;
let editor = null;
let start_time = Date.now();
function parseErrorsAsync() {
    const results = [];
    let parsing = current_errors;
    const messages = [];
    let file_path = "";
    parsing = parsing.substring(0, parsing.lastIndexOf(" problem") + 1);
    let qtty = parseInt(parsing.substring(parsing.lastIndexOf("\n"), parsing.length - 1));
    let aqtty = parsing.substring(parsing.lastIndexOf("\n"), parsing.length - 1);
    while (parsing.length > 0 && qtty > 0) {
        --qtty;
        const fileAndWhere = parsing.substring(0, parsing.indexOf(" "));
        parsing = parsing.substring(parsing.indexOf(" "));
        const message = parsing.substring(0, parsing.indexOf("\n"));
        parsing = parsing.substring(parsing.indexOf("\n") + 1);
        const [fp, line, column, _] = fileAndWhere.split(":");
        file_path = fp;
        messages.push({
            message: message,
            line: Number(line) - 1,
            column: Number(column) - 1,
            ruleId: null,
        });
    }
    results.push({
        filePath: file_path,
        messages: messages,
        errorCount: messages.length,
        fatalErrorCount: 0,
        warningCount: 0,
        fixableErrorCount: 0,
        fixableWarningCount: 0,
    });
    return fromLintToLinter(results);
}
function fromLintToLinter(results) {
    const promises = [];
    for (let i = 0; i < results.length; ++i) {
        for (let j = 0; j < results[i].messages.length; ++j) {
            promises.push({
                severity: "error",
                excerpt: results[i].messages[j].message,
                location: {
                    file: results[i].filePath,
                    position: (0, atom_linter_1.generateRange)(editor, results[i].messages[j].line, results[i].messages[j].column),
                },
            });
        }
    }
    return Promise.resolve(promises);
}
function waitToReady() {
    return new Promise((resolve, reject) => {
        const id = setInterval(() => {
            if (next_ready || Date.now() > start_time + 30000) {
                clearInterval(id);
                resolve(parseErrorsAsync());
            }
        });
    });
}
let current_errors = "";
let current_results = null;
const current_config = exports.config;
let running = false;
let child = null;
function logNotification(text, tittle = "-- DEBUG --") {
    const args = { dismissable: tittle === "-- DEBUG --", detail: text };
    atom.notifications.addInfo(tittle, args);
}
function activate() {
    atom.commands.add("atom-workspace", {
        "auto-prettier-eslint:run": () => {
            run();
        },
    });
    atom.workspace.observeTextEditors((editor) => {
        editor.onDidSave(() => {
            atom.notifications.clear();
            const files = getValidFilePaths(current_config.prettierFileType.get(), getCurrentFilePath());
            if (files.length === 0)
                return;
            if (running && child) {
                child.kill();
                running = false;
            }
            if (!running) {
                if (current_config.notifications.get()) {
                    logNotification("", "Running auto-prettier-eslint");
                }
                running = true;
                run();
            }
        });
    });
}
exports.activate = activate;
function serialize() { }
exports.serialize = serialize;
function run() {
    execPrettier(getCurrentFilePath());
}
exports.run = run;
function getCurrentWorkingDir(filepath) {
    let cwd;
    atom.project.getDirectories().forEach(function (dir) {
        const dirpath = dir.getPath();
        const relpath = path_1.default.relative(dirpath, filepath);
        const dirIsParent = !/^\.\.\//.test(relpath);
        if (dirIsParent) {
            cwd = dirpath;
        }
    });
    cwd = cwd || process.cwd();
    return cwd;
}
function getCurrentFilePath() {
    return atom.workspace.getActivePaneItem().getPath();
}
exports.getCurrentFilePath = getCurrentFilePath;
function getPathToESLint(cwd) {
    if (current_config.eslintPath.get()) {
        return current_config.eslintPath.get();
    }
    if (fs_1.default.existsSync(`${cwd}/node_modules/.bin/eslint`)) {
        return "./node_modules/.bin/eslint";
    }
    return "eslint";
}
exports.getPathToESLint = getPathToESLint;
function getPathToPrettier(cwd) {
    if (current_config.prettierPath.get()) {
        return current_config.prettierPath.get();
    }
    if (fs_1.default.existsSync(`${cwd}/node_modules/.bin/prettier`)) {
        return "./node_modules/.bin/prettier";
    }
    return "prettier";
}
exports.getPathToPrettier = getPathToPrettier;
function getValidFilePaths(fileType, filepath) {
    const files = [];
    const paths = filepath instanceof Array ? filepath.slice() : [filepath];
    const rex = new RegExp("\\.(" + fileType.replace(/\s*,\s*/g, "|") + ")$");
    for (let i = 0; i < paths.length; ++i) {
        if (rex.test(paths[i])) {
            files.push(paths[i]);
        }
    }
    return files;
}
exports.getValidFilePaths = getValidFilePaths;
function execPrettier(filepath) {
    const args = getValidFilePaths(current_config.prettierFileType.get(), filepath);
    if (args.length === 0) {
        running = false;
        return;
    }
    args.unshift("-w");
    args.unshift("--cache");
    const cwd = getCurrentWorkingDir(filepath);
    const runner = getPathToPrettier(cwd);
    cliExec(cwd, runner, args, () => {
        execEslint(filepath);
    });
}
exports.execPrettier = execPrettier;
function execEslint(filepath) {
    const args = getValidFilePaths(current_config.eslintFileType.get(), filepath);
    if (args.length === 0) {
        running = false;
        return;
    }
    args.unshift("--fix");
    args.unshift("--cache");
    args.unshift("--no-ignore");
    args.unshift("--format=unix");
    const cwd = getCurrentWorkingDir(filepath);
    const runner = getPathToESLint(cwd);
    cliExec(cwd, runner, args, () => { });
}
exports.execEslint = execEslint;
function cliExec(cwd, runner, arg, callback) {
    if (runner.includes("eslint")) {
    }
    child = (0, child_process_1.execFile)(runner, arg, { cwd, shell: false }, (error, stdout, stderr) => {
        const out = stdout;
        const err = stderr;
        const args = { detail: err ? err + "\n" + out : out, dismissable: false };
        const notif = error ? current_config.zerror.get() : current_config.ysuccess.get();
        if (current_config.notifications.get()) {
            logNotification("", runner + " compleated");
        }
        if (runner.includes("eslint")) {
            current_errors = out;
            if (current_results != null) {
                current_results.then(parseErrorsAsync);
            }
            next_ready = true;
        }
        running = false;
        child = null;
        callback();
        if (notif.type === "none") {
            return;
        }
        else if (notif.type === "dismissable" && err.length + out.length > 0) {
            args.dismissable = true;
        }
        if (error) {
            atom.notifications.addError(runner + " failed", args);
        }
        else {
            atom.notifications.addSuccess(runner + " successful", args);
        }
    });
}
exports.cliExec = cliExec;
function provideLinter() {
    return {
        name: "Eslint",
        grammarScopes: ["source.ts"],
        scope: "file",
        lintsOnChange: false,
        lint: (current_editor) => {
            editor = current_editor;
            next_ready = false;
            start_time = Date.now();
            current_results = waitToReady();
            return current_results;
        },
    };
}
exports.provideLinter = provideLinter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0by1wcmV0dGllci1lc2xpbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvYXV0by1wcmV0dGllci1lc2xpbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7Ozs7QUFFYixpREFBeUM7QUFDekMsNERBQWlDO0FBQ2pDLGdEQUF3QjtBQUN4Qiw0Q0FBb0I7QUFDcEIsNkNBQTRDO0FBRTVDLG9EQUE0QjtBQUU1QixNQUFNLFNBQVMsR0FBa0IsSUFBSSxnQkFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUV2RCxTQUFTLFlBQVksQ0FBQyxLQUFLO0lBQ3pCLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztJQUNoQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3RDLE1BQU0sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFDRCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDO0FBRVksUUFBQSxNQUFNLEdBQUcsbUJBQU0sQ0FBQztBQUM3QixJQUFJLFVBQVUsR0FBRyxLQUFLLENBQUM7QUFDdkIsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO0FBQ2xCLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUU1QixTQUFTLGdCQUFnQjtJQUN2QixNQUFNLE9BQU8sR0FBRyxFQUFFLENBQUM7SUFDbkIsSUFBSSxPQUFPLEdBQUcsY0FBYyxDQUFDO0lBQzdCLE1BQU0sUUFBUSxHQUFrQixFQUFFLENBQUM7SUFDbkMsSUFBSSxTQUFTLEdBQUcsRUFBRSxDQUFDO0lBQ25CLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxH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QUFDO1lBQzFCLE9BQU87UUFDVCxDQUFDO2FBQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLGFBQWEsSUFBSSxHQUFHLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDdkUsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDMUIsQ0FBQztRQUNELElBQUksS0FBSyxFQUFFLENBQUM7WUFDVixJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3hELENBQUM7YUFBTSxDQUFDO1lBQ04sSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM5RCxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBM0NELDBCQTJDQztBQUVELFNBQWdCLGFBQWE7SUFDM0IsT0FBTztRQUNMLElBQUksRUFBRSxRQUFRO1FBQ2QsYUFBYSxFQUFFLENBQUMsV0FBVyxDQUFDO1FBQzVCLEtBQUssRUFBRSxNQUFNO1FBQ2IsYUFBYSxFQUFFLEtBQUs7UUFDcEIsSUFBSSxFQUFFLENBQUMsY0FBYyxFQUFrQixFQUFFO1lBQ3ZDLE1BQU0sR0FBRyxjQUFjLENBQUM7WUFDeEIsVUFBVSxHQUFHLEtBQUssQ0FBQztZQUNuQixVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3hCLGVBQWUsR0FBRyxXQUFXLEVBQUUsQ0FBQztZQUNoQyxPQUFPLGVBQWUsQ0FBQztRQUN6QixDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUM7QUFkRCxzQ0FjQyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgeyBleGVjRmlsZSB9IGZyb20gXCJjaGlsZF9wcm9jZXNzXCI7XG5pbXBvcnQgQ29uZmlnIGZyb20gXCIuL2NvbmZpZy5qc1wiO1xuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCB7IGdlbmVyYXRlUmFuZ2UgfSBmcm9tIFwiYXRvbS1saW50ZXJcIjtcbmltcG9ydCB7IExpbnRSZXN1bHQsIExpbnRNZXNzYWdlIH0gZnJvbSBcIi4vRVNsaW50VHlwZXMuZC5qc1wiO1xuaW1wb3J0IEVTTGludCBmcm9tIFwiZXNsaW50XCI7XG5cbmNvbnN0IGNsaUVuZ2luZTogRVNMaW50LkVTTGludCA9IG5ldyBFU0xpbnQuRVNMaW50KHt9KTtcblxuZnVuY3Rpb24gYnl0ZXMyU3RyaW5nKGJ5dGVzKSB7XG4gIGxldCByZXN1bHQgPSBcIlwiO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGJ5dGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgcmVzdWx0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnl0ZXNbaV0pO1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBjb25zdCBjb25maWcgPSBDb25maWc7XG5sZXQgbmV4dF9yZWFkeSA9IGZhbHNlO1xubGV0IGVkaXRvciA9IG51bGw7XG5sZXQgc3RhcnRfdGltZSA9IERhdGUubm93KCk7XG5cbmZ1bmN0aW9uIHBhcnNlRXJyb3JzQXN5bmMoKSB7XG4gIGNvbnN0IHJlc3VsdHMgPSBbXTtcbiAgbGV0IHBhcnNpbmcgPSBjdXJyZW50X2Vycm9ycztcbiAgY29uc3QgbWVzc2FnZXM6IExpbnRNZXNzYWdlW10gPSBbXTtcbiAgbGV0IGZpbGVfcGF0aCA9IFwiXCI7XG4gIHBhcnNpbmcgPSBwYXJzaW5nLnN1YnN0cmluZygwLCBwYXJzaW5nLmxhc3RJbmRleE9mKFwiIHByb2JsZW1cIikgKyAxKTtcbiAgbGV0IHF0dHkgPSBwYXJzZUludChwYXJzaW5nLnN1YnN0cmluZyhwYXJzaW5nLmxhc3RJbmRleE9mKFwiXFxuXCIpLCBwYXJzaW5nLmxlbmd0aCAtIDEpKTtcbiAgbGV0IGFxdHR5ID0gcGFyc2luZy5zdWJzdHJpbmcocGFyc2luZy5sYXN0SW5kZXhPZihcIlxcblwiKSwgcGFyc2luZy5sZW5ndGggLSAxKTtcbiAgd2hpbGUgKHBhcnNpbmcubGVuZ3RoID4gMCAmJiBxdHR5ID4gMCkge1xuICAgIC0tcXR0eTtcbiAgICBjb25zdCBmaWxlQW5kV2hlcmUgPSBwYXJzaW5nLnN1YnN0cmluZygwLCBwYXJzaW5nLmluZGV4T2YoXCIgXCIpKTtcbiAgICBwYXJzaW5nID0gcGFyc2luZy5zdWJzdHJpbmcocGFyc2luZy5pbmRleE9mKFwiIFwiKSk7XG5cbiAgICBjb25zdCBtZXNzYWdlID0gcGFyc2luZy5zdWJzdHJpbmcoMCwgcGFyc2luZy5pbmRleE9mKFwiXFxuXCIpKTtcbiAgICBwYXJzaW5nID0gcGFyc2luZy5zdWJzdHJpbmcocGFyc2luZy5pbmRleE9mKFwiXFxuXCIpICsgMSk7XG5cbiAgICBjb25zdCBbZnAsIGxpbmUsIGNvbHVtbiwgX10gPSBmaWxlQW5kV2hlcmUuc3BsaXQoXCI6XCIpO1xuICAgIGZpbGVfcGF0aCA9IGZwO1xuICAgIG1lc3NhZ2VzLnB1c2goe1xuICAgICAgbWVzc2FnZTogbWVzc2FnZSxcbiAgICAgIGxpbmU6IE51bWJlcihsaW5lKSAtIDEsXG4gICAgICBjb2x1bW46IE51bWJlcihjb2x1bW4pIC0gMSxcbiAgICAgIHJ1bGVJZDogbnVsbCxcbiAgICB9IGFzIExpbnRNZXNzYWdlKTtcbiAgfVxuICByZXN1bHRzLnB1c2goe1xuICAgIGZpbGVQYXRoOiBmaWxlX3BhdGgsXG4gICAgbWVzc2FnZXM6IG1lc3NhZ2VzLFxuICAgIGVycm9yQ291bnQ6IG1lc3NhZ2VzLmxlbmd0aCxcbiAgICBmYXRhbEVycm9yQ291bnQ6IDAsXG4gICAgd2FybmluZ0NvdW50OiAwLFxuICAgIGZpeGFibGVFcnJvckNvdW50OiAwLFxuICAgIGZpeGFibGVXYXJuaW5nQ291bnQ6IDAsXG4gIH0gYXMgTGludFJlc3VsdCk7XG4gIHJldHVybiBmcm9tTGludFRvTGludGVyKHJlc3VsdHMpO1xufVxuXG5mdW5jdGlvbiBmcm9tTGludFRvTGludGVyKHJlc3VsdHM6IExpbnRSZXN1bHRbXSk6IFByb21pc2U8YW55W10+IHtcbiAgY29uc3QgcHJvbWlzZXMgPSBbXTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHRzLmxlbmd0aDsgKytpKSB7XG4gICAgZm9yIChsZXQgaiA9IDA7IGogPCByZXN1bHRzW2ldLm1lc3NhZ2VzLmxlbmd0aDsgKytqKSB7XG4gICAgICBwcm9taXNlcy5wdXNoKHtcbiAgICAgICAgc2V2ZXJpdHk6IFwiZXJyb3JcIiwgLy8gcmVzdWx0c1tpXS5tZXNzYWdlc1tqXS5zZXZlcml0eSxcbiAgICAgICAgZXhjZXJwdDogcmVzdWx0c1tpXS5tZXNzYWdlc1tqXS5tZXNzYWdlLFxuICAgICAgICBsb2NhdGlvbjoge1xuICAgICAgICAgIGZpbGU6IHJlc3VsdHNbaV0uZmlsZVBhdGgsXG4gICAgICAgICAgcG9zaXRpb246IGdlbmVyYXRlUmFuZ2UoZWRpdG9yLCByZXN1bHRzW2ldLm1lc3NhZ2VzW2pdLmxpbmUsIHJlc3VsdHNbaV0ubWVzc2FnZXNbal0uY29sdW1uKSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHByb21pc2VzKTtcbn1cblxuZnVuY3Rpb24gd2FpdFRvUmVhZHkoKTogUHJvbWlzZTxhbnlbXT4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGNvbnN0IGlkID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgaWYgKG5leHRfcmVhZHkgfHwgRGF0ZS5ub3coKSA+IHN0YXJ0X3RpbWUgKyAzMDAwMCkge1xuICAgICAgICBjbGVhckludGVydmFsKGlkKTtcbiAgICAgICAgcmVzb2x2ZShwYXJzZUVycm9yc0FzeW5jKCkpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxubGV0IGN1cnJlbnRfZXJyb3JzID0gXCJcIjtcbmxldCBjdXJyZW50X3Jlc3VsdHM6IFByb21pc2U8YW55W10+IHwgbnVsbCA9IG51bGw7XG5jb25zdCBjdXJyZW50X2NvbmZpZyA9IGNvbmZpZztcbmxldCBydW5uaW5nID0gZmFsc2U7XG5sZXQgY2hpbGQgPSBudWxsO1xuXG5mdW5jdGlvbiBsb2dOb3RpZmljYXRpb24odGV4dCwgdGl0dGxlID0gXCItLSBERUJVRyAtLVwiKSB7XG4gIGNvbnN0IGFyZ3MgPSB7IGRpc21pc3NhYmxlOiB0aXR0bGUgPT09IFwiLS0gREVCVUcgLS1cIiwgZGV0YWlsOiB0ZXh0IH07XG4gIGF0b20ubm90aWZpY2F0aW9ucy5hZGRJbmZvKHRpdHRsZSwgYXJncyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZSgpIHtcbiAgYXRvbS5jb21tYW5kcy5hZGQoXCJhdG9tLXdvcmtzcGFjZVwiLCB7XG4gICAgXCJhdXRvLXByZXR0aWVyLWVzbGludDpydW5cIjogKCkgPT4ge1xuICAgICAgcnVuKCk7XG4gICAgfSxcbiAgfSk7XG5cbiAgYXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZVRleHRFZGl0b3JzKChlZGl0b3IpID0+IHtcbiAgICBlZGl0b3Iub25EaWRTYXZlKCgpID0+IHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5jbGVhcigpO1xuICAgICAgY29uc3QgZmlsZXMgPSBnZXRWYWxpZEZpbGVQYXRocyhjdXJyZW50X2NvbmZpZy5wcmV0dGllckZpbGVUeXBlLmdldCgpLCBnZXRDdXJyZW50RmlsZVBhdGgoKSk7XG4gICAgICBpZiAoZmlsZXMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICBpZiAocnVubmluZyAmJiBjaGlsZCkge1xuICAgICAgICBjaGlsZC5raWxsKCk7XG4gICAgICAgIHJ1bm5pbmcgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmICghcnVubmluZykge1xuICAgICAgICBpZiAoY3VycmVudF9jb25maWcubm90aWZpY2F0aW9ucy5nZXQoKSkge1xuICAgICAgICAgIGxvZ05vdGlmaWNhdGlvbihcIlwiLCBcIlJ1bm5pbmcgYXV0by1wcmV0dGllci1lc2xpbnRcIik7XG4gICAgICAgIH1cbiAgICAgICAgcnVubmluZyA9IHRydWU7XG4gICAgICAgIHJ1bigpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlcmlhbGl6ZSgpIHt9XG5cbmV4cG9ydCBmdW5jdGlvbiBydW4oKSB7XG4gIGV4ZWNQcmV0dGllcihnZXRDdXJyZW50RmlsZVBhdGgoKSk7XG59XG5cbmZ1bmN0aW9uIGdldEN1cnJlbnRXb3JraW5nRGlyKGZpbGVwYXRoKSB7XG4gIGxldCBjd2Q7XG4gIGF0b20ucHJvamVjdC5nZXREaXJlY3RvcmllcygpLmZvckVhY2goZnVuY3Rpb24gKGRpcikge1xuICAgIGNvbnN0IGRpcnBhdGggPSBkaXIuZ2V0UGF0aCgpO1xuICAgIGNvbnN0IHJlbHBhdGggPSBwYXRoLnJlbGF0aXZlKGRpcnBhdGgsIGZpbGVwYXRoKTtcbiAgICBjb25zdCBkaXJJc1BhcmVudCA9ICEvXlxcLlxcLlxcLy8udGVzdChyZWxwYXRoKTtcbiAgICBpZiAoZGlySXNQYXJlbnQpIHtcbiAgICAgIGN3ZCA9IGRpcnBhdGg7XG4gICAgfVxuICB9KTtcbiAgY3dkID0gY3dkIHx8IHByb2Nlc3MuY3dkKCk7XG4gIHJldHVybiBjd2Q7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDdXJyZW50RmlsZVBhdGgoKSB7XG4gIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgcmV0dXJuIGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVBhbmVJdGVtKCkuZ2V0UGF0aCgpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGF0aFRvRVNMaW50KGN3ZCkge1xuICBpZiAoY3VycmVudF9jb25maWcuZXNsaW50UGF0aC5nZXQoKSkge1xuICAgIHJldHVybiBjdXJyZW50X2NvbmZpZy5lc2xpbnRQYXRoLmdldCgpO1xuICB9XG4gIGlmIChmcy5leGlzdHNTeW5jKGAke2N3ZH0vbm9kZV9tb2R1bGVzLy5iaW4vZXNsaW50YCkpIHtcbiAgICByZXR1cm4gXCIuL25vZGVfbW9kdWxlcy8uYmluL2VzbGludFwiO1xuICB9XG4gIHJldHVybiBcImVzbGludFwiO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGF0aFRvUHJldHRpZXIoY3dkKSB7XG4gIGlmIChjdXJyZW50X2NvbmZpZy5wcmV0dGllclBhdGguZ2V0KCkpIHtcbiAgICByZXR1cm4gY3VycmVudF9jb25maWcucHJldHRpZXJQYXRoLmdldCgpO1xuICB9XG4gIGlmIChmcy5leGlzdHNTeW5jKGAke2N3ZH0vbm9kZV9tb2R1bGVzLy5iaW4vcHJldHRpZXJgKSkge1xuICAgIHJldHVybiBcIi4vbm9kZV9tb2R1bGVzLy5iaW4vcHJldHRpZXJcIjtcbiAgfVxuICByZXR1cm4gXCJwcmV0dGllclwiO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VmFsaWRGaWxlUGF0aHMoZmlsZVR5cGUsIGZpbGVwYXRoKSB7XG4gIGNvbnN0IGZpbGVzID0gW107XG4gIGNvbnN0IHBhdGhzID0gZmlsZXBhdGggaW5zdGFuY2VvZiBBcnJheSA/IGZpbGVwYXRoLnNsaWNlKCkgOiBbZmlsZXBhdGhdO1xuICBjb25zdCByZXggPSBuZXcgUmVnRXhwKFwiXFxcXC4oXCIgKyBmaWxlVHlwZS5yZXBsYWNlKC9cXHMqLFxccyovZywgXCJ8XCIpICsgXCIpJFwiKTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXRocy5sZW5ndGg7ICsraSkge1xuICAgIGlmIChyZXgudGVzdChwYXRoc1tpXSkpIHtcbiAgICAgIGZpbGVzLnB1c2gocGF0aHNbaV0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmlsZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBleGVjUHJldHRpZXIoZmlsZXBhdGgpIHtcbiAgY29uc3QgYXJncyA9IGdldFZhbGlkRmlsZVBhdGhzKGN1cnJlbnRfY29uZmlnLnByZXR0aWVyRmlsZVR5cGUuZ2V0KCksIGZpbGVwYXRoKTtcbiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgcnVubmluZyA9IGZhbHNlO1xuICAgIHJldHVybjtcbiAgfVxuICBhcmdzLnVuc2hpZnQoXCItd1wiKTtcbiAgYXJncy51bnNoaWZ0KFwiLS1jYWNoZVwiKTtcbiAgY29uc3QgY3dkID0gZ2V0Q3VycmVudFdvcmtpbmdEaXIoZmlsZXBhdGgpO1xuICBjb25zdCBydW5uZXIgPSBnZXRQYXRoVG9QcmV0dGllcihjd2QpO1xuICBjbGlFeGVjKGN3ZCwgcnVubmVyLCBhcmdzLCAoKSA9PiB7XG4gICAgZXhlY0VzbGludChmaWxlcGF0aCk7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXhlY0VzbGludChmaWxlcGF0aCkge1xuICBjb25zdCBhcmdzID0gZ2V0VmFsaWRGaWxlUGF0aHMoY3VycmVudF9jb25maWcuZXNsaW50RmlsZVR5cGUuZ2V0KCksIGZpbGVwYXRoKTtcbiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgcnVubmluZyA9IGZhbHNlO1xuICAgIHJldHVybjtcbiAgfVxuICBhcmdzLnVuc2hpZnQoXCItLWZpeFwiKTtcbiAgYXJncy51bnNoaWZ0KFwiLS1jYWNoZVwiKTtcbiAgYXJncy51bnNoaWZ0KFwiLS1uby1pZ25vcmVcIik7XG4gIGFyZ3MudW5zaGlmdChcIi0tZm9ybWF0PXVuaXhcIik7XG5cbiAgY29uc3QgY3dkID0gZ2V0Q3VycmVudFdvcmtpbmdEaXIoZmlsZXBhdGgpO1xuICBjb25zdCBydW5uZXIgPSBnZXRQYXRoVG9FU0xpbnQoY3dkKTtcbiAgY2xpRXhlYyhjd2QsIHJ1bm5lciwgYXJncywgKCkgPT4ge30pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2xpRXhlYyhjd2QsIHJ1bm5lciwgYXJnLCBjYWxsYmFjaykge1xuICBpZiAocnVubmVyLmluY2x1ZGVzKFwiZXNsaW50XCIpKSB7XG4gICAgLy8gY29uc3QgZmlsZSA9IGFyZ1thcmcubGVuZ3RoIC0gMV07XG4gICAgLy8gY29uc3QgcGFyc2VFcnJvcnNBc3luYyA9IChyZXN1bHQ6IGFueVtdKSA9PiB7XG4gICAgLy8gICAgIGNvbnN0IHJlc3VsdDIgPSBjbGlFbmdpbmUubGludEZpbGVzKGZpbGUpIGFzIGFueSBhcyBMaW50UmVzdWx0W107XG4gICAgLy8gICAgIHJldHVybiByZXN1bHQuY29uY2F0KHJlc3VsdDIpO1xuICAgIC8vICAgfTtcbiAgICAvL1xuICAgIC8vIGlmIChjdXJyZW50X3Jlc3VsdHMgIT0gbnVsbCkge1xuICAgIC8vICAgY3VycmVudF9yZXN1bHRzLnRoZW4ocGFyc2VFcnJvcnNBc3luYyk7XG4gICAgLy8gfVxuICB9XG5cbiAgY2hpbGQgPSBleGVjRmlsZShydW5uZXIsIGFyZywgeyBjd2QsIHNoZWxsOiBmYWxzZSB9LCAoZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgY29uc3Qgb3V0ID0gc3Rkb3V0O1xuICAgIGNvbnN0IGVyciA9IHN0ZGVycjtcbiAgICBjb25zdCBhcmdzID0geyBkZXRhaWw6IGVyciA/IGVyciArIFwiXFxuXCIgKyBvdXQgOiBvdXQsIGRpc21pc3NhYmxlOiBmYWxzZSB9O1xuICAgIGNvbnN0IG5vdGlmID0gZXJyb3IgPyBjdXJyZW50X2NvbmZpZy56ZXJyb3IuZ2V0KCkgOiBjdXJyZW50X2NvbmZpZy55c3VjY2Vzcy5nZXQoKTtcbiAgICBpZiAoY3VycmVudF9jb25maWcubm90aWZpY2F0aW9ucy5nZXQoKSkge1xuICAgICAgbG9nTm90aWZpY2F0aW9uKFwiXCIsIHJ1bm5lciArIFwiIGNvbXBsZWF0ZWRcIik7XG4gICAgfVxuICAgIGlmIChydW5uZXIuaW5jbHVkZXMoXCJlc2xpbnRcIikpIHtcbiAgICAgIGN1cnJlbnRfZXJyb3JzID0gb3V0O1xuICAgICAgaWYgKGN1cnJlbnRfcmVzdWx0cyAhPSBudWxsKSB7XG4gICAgICAgIGN1cnJlbnRfcmVzdWx0cy50aGVuKHBhcnNlRXJyb3JzQXN5bmMpO1xuICAgICAgfVxuICAgICAgbmV4dF9yZWFkeSA9IHRydWU7XG4gICAgfVxuICAgIHJ1bm5pbmcgPSBmYWxzZTtcbiAgICBjaGlsZCA9IG51bGw7XG4gICAgY2FsbGJhY2soKTtcbiAgICAvLyBub3RpZmljYXRpb25zIGhhbmRsZVxuICAgIGlmIChub3RpZi50eXBlID09PSBcIm5vbmVcIikge1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSBpZiAobm90aWYudHlwZSA9PT0gXCJkaXNtaXNzYWJsZVwiICYmIGVyci5sZW5ndGggKyBvdXQubGVuZ3RoID4gMCkge1xuICAgICAgYXJncy5kaXNtaXNzYWJsZSA9IHRydWU7XG4gICAgfVxuICAgIGlmIChlcnJvcikge1xuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKHJ1bm5lciArIFwiIGZhaWxlZFwiLCBhcmdzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFN1Y2Nlc3MocnVubmVyICsgXCIgc3VjY2Vzc2Z1bFwiLCBhcmdzKTtcbiAgICB9XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvdmlkZUxpbnRlcigpIHtcbiAgcmV0dXJuIHtcbiAgICBuYW1lOiBcIkVzbGludFwiLFxuICAgIGdyYW1tYXJTY29wZXM6IFtcInNvdXJjZS50c1wiXSxcbiAgICBzY29wZTogXCJmaWxlXCIsXG4gICAgbGludHNPbkNoYW5nZTogZmFsc2UsXG4gICAgbGludDogKGN1cnJlbnRfZWRpdG9yKTogUHJvbWlzZTxhbnlbXT4gPT4ge1xuICAgICAgZWRpdG9yID0gY3VycmVudF9lZGl0b3I7XG4gICAgICBuZXh0X3JlYWR5ID0gZmFsc2U7XG4gICAgICBzdGFydF90aW1lID0gRGF0ZS5ub3coKTtcbiAgICAgIGN1cnJlbnRfcmVzdWx0cyA9IHdhaXRUb1JlYWR5KCk7XG4gICAgICByZXR1cm4gY3VycmVudF9yZXN1bHRzO1xuICAgIH0sXG4gIH07XG59XG4iXX0=