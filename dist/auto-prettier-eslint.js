"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.provideLinter = exports.cliExec = exports.execEslint = exports.execPrettier = exports.getValidFilePaths = exports.getPathToPrettier = exports.getPathToESLint = exports.getCurrentFilePath = exports.run = exports.serialize = exports.activate = exports.config = void 0;
const child_process_1 = require("child_process");
const config_js_1 = __importDefault(require("./config.js"));
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const atom_linter_1 = require("atom-linter");
const eslint_1 = __importDefault(require("eslint"));
const cliEngine = new eslint_1.default.ESLint({});
function bytes2String(bytes) {
    let result = "";
    for (let i = 0; i < bytes.length; i++) {
        result += String.fromCharCode(bytes[i]);
    }
    return result;
}
exports.config = config_js_1.default;
let next_ready = false;
let editor = null;
let start_time = Date.now();
function parseErrorsAsync() {
    const results = [];
    let parsing = current_errors;
    const messages = [];
    let file_path = "";
    parsing = parsing.substring(0, parsing.lastIndexOf(" problems") + 1);
    let qtty = parseInt(parsing.substring(parsing.lastIndexOf("\n"), parsing.length - 1));
    let aqtty = parsing.substring(parsing.lastIndexOf("\n"), parsing.length - 1);
    while (parsing.length > 0 && qtty > 0) {
        --qtty;
        const fileAndWhere = parsing.substring(0, parsing.indexOf(" "));
        parsing = parsing.substring(parsing.indexOf(" "));
        const message = parsing.substring(0, parsing.indexOf("\n"));
        parsing = parsing.substring(parsing.indexOf("\n") + 1);
        const [fp, line, column, _] = fileAndWhere.split(":");
        file_path = fp;
        messages.push({
            message: message,
            line: Number(line) - 1,
            column: Number(column) - 1,
            ruleId: null,
        });
    }
    results.push({
        filePath: file_path,
        messages: messages,
        errorCount: messages.length,
        fatalErrorCount: 0,
        warningCount: 0,
        fixableErrorCount: 0,
        fixableWarningCount: 0,
    });
    return fromLintToLinter(results);
}
function fromLintToLinter(results) {
    const promises = [];
    for (let i = 0; i < results.length; ++i) {
        for (let j = 0; j < results[i].messages.length; ++j) {
            promises.push({
                severity: "error",
                excerpt: results[i].messages[j].message,
                location: {
                    file: results[i].filePath,
                    position: (0, atom_linter_1.generateRange)(editor, results[i].messages[j].line, results[i].messages[j].column),
                },
            });
        }
    }
    return Promise.resolve(promises);
}
function waitToReady() {
    return new Promise((resolve, reject) => {
        const id = setInterval(() => {
            if (next_ready || Date.now() > start_time + 30000) {
                clearInterval(id);
                resolve(parseErrorsAsync());
            }
        });
    });
}
let current_errors = "";
let current_results = null;
const current_config = exports.config;
let running = false;
let child = null;
function logNotification(text, tittle = "-- DEBUG --") {
    const args = { dismissable: tittle === "-- DEBUG --", detail: text };
    atom.notifications.addInfo(tittle, args);
}
function activate() {
    atom.commands.add("atom-workspace", {
        "auto-prettier-eslint:run": () => {
            run();
        },
    });
    atom.workspace.observeTextEditors((editor) => {
        editor.onDidSave(() => {
            atom.notifications.clear();
            const files = getValidFilePaths(current_config.prettierFileType.get(), getCurrentFilePath());
            if (files.length === 0)
                return;
            if (running && child) {
                child.kill();
                running = false;
            }
            if (!running) {
                if (current_config.notifications.get()) {
                    logNotification("", "Running auto-prettier-eslint");
                }
                running = true;
                run();
            }
        });
    });
}
exports.activate = activate;
function serialize() { }
exports.serialize = serialize;
function run() {
    execPrettier(getCurrentFilePath());
}
exports.run = run;
function getCurrentWorkingDir(filepath) {
    let cwd;
    atom.project.getDirectories().forEach(function (dir) {
        const dirpath = dir.getPath();
        const relpath = path_1.default.relative(dirpath, filepath);
        const dirIsParent = !/^\.\.\//.test(relpath);
        if (dirIsParent) {
            cwd = dirpath;
        }
    });
    cwd = cwd || process.cwd();
    return cwd;
}
function getCurrentFilePath() {
    return atom.workspace.getActivePaneItem().getPath();
}
exports.getCurrentFilePath = getCurrentFilePath;
function getPathToESLint(cwd) {
    if (current_config.eslintPath.get()) {
        return current_config.eslintPath.get();
    }
    if (fs_1.default.existsSync(`${cwd}/node_modules/.bin/eslint`)) {
        return "./node_modules/.bin/eslint";
    }
    return "eslint";
}
exports.getPathToESLint = getPathToESLint;
function getPathToPrettier(cwd) {
    if (current_config.prettierPath.get()) {
        return current_config.prettierPath.get();
    }
    if (fs_1.default.existsSync(`${cwd}/node_modules/.bin/prettier`)) {
        return "./node_modules/.bin/prettier";
    }
    return "prettier";
}
exports.getPathToPrettier = getPathToPrettier;
function getValidFilePaths(fileType, filepath) {
    const files = [];
    const paths = filepath instanceof Array ? filepath.slice() : [filepath];
    const rex = new RegExp("\\.(" + fileType.replace(/\s*,\s*/g, "|") + ")$");
    for (let i = 0; i < paths.length; ++i) {
        if (rex.test(paths[i])) {
            files.push(paths[i]);
        }
    }
    return files;
}
exports.getValidFilePaths = getValidFilePaths;
function execPrettier(filepath) {
    const args = getValidFilePaths(current_config.prettierFileType.get(), filepath);
    if (args.length === 0) {
        running = false;
        return;
    }
    args.unshift("-w");
    args.unshift("--cache");
    const cwd = getCurrentWorkingDir(filepath);
    const runner = getPathToPrettier(cwd);
    cliExec(cwd, runner, args, () => {
        execEslint(filepath);
    });
}
exports.execPrettier = execPrettier;
function execEslint(filepath) {
    const args = getValidFilePaths(current_config.eslintFileType.get(), filepath);
    if (args.length === 0) {
        running = false;
        return;
    }
    args.unshift("--fix");
    args.unshift("--cache");
    args.unshift("--no-ignore");
    args.unshift("--format=unix");
    const cwd = getCurrentWorkingDir(filepath);
    const runner = getPathToESLint(cwd);
    cliExec(cwd, runner, args, () => { });
}
exports.execEslint = execEslint;
function cliExec(cwd, runner, arg, callback) {
    if (runner.includes("eslint")) {
    }
    child = (0, child_process_1.execFile)(runner, arg, { cwd, shell: false }, (error, stdout, stderr) => {
        const out = stdout;
        const err = stderr;
        const args = { detail: err ? err + "\n" + out : out, dismissable: false };
        const notif = error ? current_config.zerror.get() : current_config.ysuccess.get();
        if (current_config.notifications.get()) {
            logNotification("", runner + " compleated");
        }
        if (runner.includes("eslint")) {
            current_errors = out;
            if (current_results != null) {
                current_results.then(parseErrorsAsync);
            }
            next_ready = true;
        }
        running = false;
        child = null;
        callback();
        if (notif.type === "none") {
            return;
        }
        else if (notif.type === "dismissable" && err.length + out.length > 0) {
            args.dismissable = true;
        }
        if (error) {
            atom.notifications.addError(runner + " failed", args);
        }
        else {
            atom.notifications.addSuccess(runner + " successful", args);
        }
    });
}
exports.cliExec = cliExec;
function provideLinter() {
    return {
        name: "Eslint",
        grammarScopes: ["source.ts"],
        scope: "file",
        lintsOnChange: false,
        lint: (current_editor) => {
            editor = current_editor;
            next_ready = false;
            start_time = Date.now();
            current_results = waitToReady();
            return current_results;
        },
    };
}
exports.provideLinter = provideLinter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0by1wcmV0dGllci1lc2xpbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvYXV0by1wcmV0dGllci1lc2xpbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7Ozs7QUFFYixpREFBeUM7QUFDekMsNERBQWlDO0FBQ2pDLGdEQUF3QjtBQUN4Qiw0Q0FBb0I7QUFDcEIsNkNBQTRDO0FBRTVDLG9EQUE0QjtBQUU1QixNQUFNLFNBQVMsR0FBa0IsSUFBSSxnQkFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUV2RCxTQUFTLFlBQVksQ0FBQyxLQUFLO0lBQ3pCLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztJQUNoQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3RDLE1BQU0sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFDRCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDO0FBRVksUUFBQSxNQUFNLEdBQUcsbUJBQU0sQ0FBQztBQUM3QixJQUFJLFVBQVUsR0FBRyxLQUFLLENBQUM7QUFDdkIsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO0FBQ2xCLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUU1QixTQUFTLGdCQUFnQjtJQUN2QixNQUFNLE9BQU8sR0FBRyxFQUFFLENBQUM7SUFDbkIsSUFBSSxPQUFPLEdBQUcsY0FBYyxDQUFDO0lBQzdCLE1BQU0sUUFBUSxHQUFrQixFQUFFLENBQUM7SUFDbkMsSUFBSSxTQUFTLEdBQUcsRUFBRSxDQUFDO0lBQ25CLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3JFLElBQUksSUFBSSxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RGLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzdFLE9BQU8sT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksSUFBSSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ3RDLEVBQUUsSUFBSSxDQUFDO1FBQ1AsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2hFLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUVsRCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDNUQsT0FBTyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUV2RCxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0RCxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ2YsUUFBUSxDQUFDLElBQUksQ0FBQztZQUNaLE9BQU8sRUFBRSxPQUFPO1lBQ2hCLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztZQUN0QixNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUM7WUFDMUIsTUFBTSxFQUFFLElBQUk7U0FDRSxDQUFDLENBQUM7SUFDcEIsQ0FBQztJQUNELE9BQU8sQ0FBQyxJQUFJLENBQUM7UUFDWCxRQUFRLEVBQUUsU0FBUztRQUNuQixRQUFRLEVBQUUsUUFBUTtRQUNsQixVQUFVLEVBQUUsUUFBUSxDQUFDLE1BQU07UUFDM0IsZUFBZSxFQUFFLENBQUM7UUFDbEIsWUFBWSxFQUFFLENBQUM7UUFDZixpQkFBaUIsRUFBRSxDQUFDO1FBQ3BCLG1CQUFtQixFQUFFLENBQUM7S0FDVCxDQUFDLENBQUM7SUFFakIsT0FBTyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNuQyxDQUFDO0FBRUQsU0FBUyxnQkFBZ0IsQ0FBQyxPQUFxQjtJQUM3QyxNQUFNLFFBQVEsR0FBRyxFQUFFLENBQUM7SUFDcEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUN4QyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztZQUNwRCxRQUFRLENBQUMsSUFBSSxDQUFDO2dCQUNaLFFBQVEsRUFBRSxPQUFPO2dCQUNqQixPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPO2dCQUN2QyxRQUFRLEVBQUU7b0JBQ1IsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRO29CQUN6QixRQUFRLEVBQUUsSUFBQSwyQkFBYSxFQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztpQkFDNUY7YUFDRixDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQztJQUNELE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNuQyxDQUFDO0FBRUQsU0FBUyxXQUFXO0lBQ2xCLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDckMsTUFBTSxFQUFFLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRTtZQUMxQixJQUFJLFVBQVUsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsVUFBVSxHQUFHLEtBQUssRUFBRSxDQUFDO2dCQUNsRCxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ2xCLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7WUFDOUIsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsSUFBSSxjQUFjLEdBQUcsRUFBRSxDQUFDO0FBQ3hCLElBQUksZUFBZSxHQUEwQixJQUFJLENBQUM7QUFDbEQsTUFBTSxjQUFjLEdBQUcsY0FBTSxDQUFDO0FBQzlCLElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQztBQUNwQixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7QUFFakIsU0FBUyxlQUFlLENBQUMsSUFBSSxFQUFFLE1BQU0sR0FBRyxhQUFhO0lBQ25ELE1BQU0sSUFBSSxHQUFHLEVBQUUsV0FBVyxFQUFFLE1BQU0sS0FBSyxhQUFhLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDO0lBQ3JFLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztBQUMzQyxDQUFDO0FBRUQsU0FBZ0IsUUFBUTtJQUN0QixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRTtRQUNsQywwQkFBMEIsRUFBRSxHQUFHLEVBQUU7WUFDL0IsR0FBRyxFQUFFLENBQUM7UUFDUixDQUFDO0tBQ0YsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO1FBQzNDLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFO1lBQ3BCLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDM0IsTUFBTSxLQUFLLEdBQUcsaUJBQWlCLENBQUMsY0FBYyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxFQUFFLGtCQUFrQixFQUFFLENBQUMsQ0FBQztZQUM3RixJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQztnQkFBRSxPQUFPO1lBQy9CLElBQUksT0FBTyxJQUFJLEtBQUssRUFBRSxDQUFDO2dCQUNyQixLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2IsT0FBTyxHQUFHLEtBQUssQ0FBQztZQUNsQixDQUFDO1lBQ0QsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNiLElBQUksY0FBYyxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDO29CQUN2QyxlQUFlLENBQUMsRUFBRSxFQUFFLDhCQUE4QixDQUFDLENBQUM7Z0JBQ3RELENBQUM7Z0JBQ0QsT0FBTyxHQUFHLElBQUksQ0FBQztnQkFDZixHQUFHLEVBQUUsQ0FBQztZQUNSLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQXpCRCw0QkF5QkM7QUFFRCxTQUFnQixTQUFTLEtBQUksQ0FBQztBQUE5Qiw4QkFBOEI7QUFFOUIsU0FBZ0IsR0FBRztJQUNqQixZQUFZLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO0FBQ3JDLENBQUM7QUFGRCxrQkFFQztBQUVELFNBQVMsb0JBQW9CLENBQUMsUUFBUTtJQUNwQyxJQUFJLEdBQUcsQ0FBQztJQUNSLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQVUsR0FBRztRQUNqRCxNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDOUIsTUFBTSxPQUFPLEdBQUcsY0FBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDakQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzdDLElBQUksV0FBVyxFQUFFLENBQUM7WUFDaEIsR0FBRyxHQUFHLE9BQU8sQ0FBQztRQUNoQixDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDSCxHQUFHLEdBQUcsR0FBRyxJQUFJLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUMzQixPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUM7QUFFRCxTQUFnQixrQkFBa0I7SUFFaEMsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLGlCQUFpQixFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDdEQsQ0FBQztBQUhELGdEQUdDO0FBRUQsU0FBZ0IsZUFBZSxDQUFDLEdBQUc7SUFDakMsSUFBSSxjQUFjLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7UUFDcEMsT0FBTyxjQUFjLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ3pDLENBQUM7SUFDRCxJQUFJLFlBQUUsQ0FBQyxVQUFVLENBQUMsR0FBRyxHQUFHLDJCQUEyQixDQUFDLEVBQUUsQ0FBQztRQUNyRCxPQUFPLDRCQUE0QixDQUFDO0lBQ3RDLENBQUM7SUFDRCxPQUFPLFFBQVEsQ0FBQztBQUNsQixDQUFDO0FBUkQsMENBUUM7QUFFRCxTQUFnQixpQkFBaUIsQ0FBQyxHQUFHO0lBQ25DLElBQUksY0FBYyxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDO1FBQ3RDLE9BQU8sY0FBYyxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUMzQyxDQUFDO0lBQ0QsSUFBSSxZQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsR0FBRyw2QkFBNkIsQ0FBQyxFQUFFLENBQUM7UUFDdkQsT0FBTyw4QkFBOEIsQ0FBQztJQUN4QyxDQUFDO0lBQ0QsT0FBTyxVQUFVLENBQUM7QUFDcEIsQ0FBQztBQVJELDhDQVFDO0FBRUQsU0FBZ0IsaUJBQWlCLENBQUMsUUFBUSxFQUFFLFFBQVE7SUFDbEQsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDO0lBQ2pCLE1BQU0sS0FBSyxHQUFHLFFBQVEsWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN4RSxNQUFNLEdBQUcsR0FBRyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFDMUUsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUN0QyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUN2QixLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZCLENBQUM7SUFDSCxDQUFDO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDO0FBVkQsOENBVUM7QUFFRCxTQUFnQixZQUFZLENBQUMsUUFBUTtJQUNuQyxNQUFNLElBQUksR0FBRyxpQkFBaUIsQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDaEYsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQ3RCLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDaEIsT0FBTztJQUNULENBQUM7SUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ25CLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDeEIsTUFBTSxHQUFHLEdBQUcsb0JBQW9CLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDM0MsTUFBTSxNQUFNLEdBQUcsaUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDdEMsT0FBTyxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRTtRQUM5QixVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdkIsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBYkQsb0NBYUM7QUFFRCxTQUFnQixVQUFVLENBQUMsUUFBUTtJQUNqQyxNQUFNLElBQUksR0FBRyxpQkFBaUIsQ0FBQyxjQUFjLENBQUMsY0FBYyxDQUFDLEdBQUcsRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzlFLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUN0QixPQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ2hCLE9BQU87SUFDVCxDQUFDO0lBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN0QixJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3hCLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDNUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUU5QixNQUFNLEdBQUcsR0FBRyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMzQyxNQUFNLE1BQU0sR0FBRyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDcEMsT0FBTyxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ3ZDLENBQUM7QUFkRCxnQ0FjQztBQUVELFNBQWdCLE9BQU8sQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxRQUFRO0lBQ2hELElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO0lBVWhDLENBQUM7SUFFRCxLQUFLLEdBQUcsSUFBQSx3QkFBUSxFQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUM3RSxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUM7UUFDbkIsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDO1FBQ25CLE1BQU0sSUFBSSxHQUFHLEVBQUUsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLENBQUM7UUFDMUUsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2xGLElBQUksY0FBYyxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDO1lBQ3ZDLGVBQWUsQ0FBQyxFQUFFLEVBQUUsTUFBTSxHQUFHLGFBQWEsQ0FBQyxDQUFDO1FBQzlDLENBQUM7UUFDRCxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztZQUM5QixjQUFjLEdBQUcsR0FBRyxDQUFDO1lBQ3JCLElBQUksZUFBZSxJQUFJLElBQUksRUFBRSxDQUFDO2dCQUM1QixlQUFlLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFDekMsQ0FBQztZQUNELFVBQVUsR0FBRyxJQUFJLENBQUM7UUFDcEIsQ0FBQztRQUNELE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDaEIsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNiLFFBQVEsRUFBRSxDQUFDO1FBRVgsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRSxDQUFDO1lBQzFCLE9BQU87UUFDVCxDQUFDO2FBQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLGFBQWEsSUFBSSxHQUFHLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDdkUsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDMUIsQ0FBQztRQUNELElBQUksS0FBSyxFQUFFLENBQUM7WUFDVixJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3hELENBQUM7YUFBTSxDQUFDO1lBQ04sSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM5RCxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBM0NELDBCQTJDQztBQWtDRCxTQUFnQixhQUFhO0lBQzNCLE9BQU87UUFDTCxJQUFJLEVBQUUsUUFBUTtRQUNkLGFBQWEsRUFBRSxDQUFDLFdBQVcsQ0FBQztRQUM1QixLQUFLLEVBQUUsTUFBTTtRQUNiLGFBQWEsRUFBRSxLQUFLO1FBQ3BCLElBQUksRUFBRSxDQUFDLGNBQWMsRUFBa0IsRUFBRTtZQUN2QyxNQUFNLEdBQUcsY0FBYyxDQUFDO1lBQ3hCLFVBQVUsR0FBRyxLQUFLLENBQUM7WUFDbkIsVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUN4QixlQUFlLEdBQUcsV0FBVyxFQUFFLENBQUM7WUFDaEMsT0FBTyxlQUFlLENBQUM7UUFDekIsQ0FBQztLQUNGLENBQUM7QUFDSixDQUFDO0FBZEQsc0NBY0MiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IHsgZXhlY0ZpbGUgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xuaW1wb3J0IENvbmZpZyBmcm9tIFwiLi9jb25maWcuanNcIjtcbmltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgeyBnZW5lcmF0ZVJhbmdlIH0gZnJvbSBcImF0b20tbGludGVyXCI7XG5pbXBvcnQgeyBMaW50UmVzdWx0LCBMaW50TWVzc2FnZSB9IGZyb20gXCIuL0VTbGludFR5cGVzLmQuanNcIjtcbmltcG9ydCBFU0xpbnQgZnJvbSBcImVzbGludFwiO1xuXG5jb25zdCBjbGlFbmdpbmU6IEVTTGludC5FU0xpbnQgPSBuZXcgRVNMaW50LkVTTGludCh7fSk7XG5cbmZ1bmN0aW9uIGJ5dGVzMlN0cmluZyhieXRlcykge1xuICBsZXQgcmVzdWx0ID0gXCJcIjtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBieXRlcy5sZW5ndGg7IGkrKykge1xuICAgIHJlc3VsdCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ5dGVzW2ldKTtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgY29uc3QgY29uZmlnID0gQ29uZmlnO1xubGV0IG5leHRfcmVhZHkgPSBmYWxzZTtcbmxldCBlZGl0b3IgPSBudWxsO1xubGV0IHN0YXJ0X3RpbWUgPSBEYXRlLm5vdygpO1xuXG5mdW5jdGlvbiBwYXJzZUVycm9yc0FzeW5jKCkge1xuICBjb25zdCByZXN1bHRzID0gW107XG4gIGxldCBwYXJzaW5nID0gY3VycmVudF9lcnJvcnM7XG4gIGNvbnN0IG1lc3NhZ2VzOiBMaW50TWVzc2FnZVtdID0gW107XG4gIGxldCBmaWxlX3BhdGggPSBcIlwiO1xuICBwYXJzaW5nID0gcGFyc2luZy5zdWJzdHJpbmcoMCwgcGFyc2luZy5sYXN0SW5kZXhPZihcIiBwcm9ibGVtc1wiKSArIDEpO1xuICBsZXQgcXR0eSA9IHBhcnNlSW50KHBhcnNpbmcuc3Vic3RyaW5nKHBhcnNpbmcubGFzdEluZGV4T2YoXCJcXG5cIiksIHBhcnNpbmcubGVuZ3RoIC0gMSkpO1xuICBsZXQgYXF0dHkgPSBwYXJzaW5nLnN1YnN0cmluZyhwYXJzaW5nLmxhc3RJbmRleE9mKFwiXFxuXCIpLCBwYXJzaW5nLmxlbmd0aCAtIDEpO1xuICB3aGlsZSAocGFyc2luZy5sZW5ndGggPiAwICYmIHF0dHkgPiAwKSB7XG4gICAgLS1xdHR5O1xuICAgIGNvbnN0IGZpbGVBbmRXaGVyZSA9IHBhcnNpbmcuc3Vic3RyaW5nKDAsIHBhcnNpbmcuaW5kZXhPZihcIiBcIikpO1xuICAgIHBhcnNpbmcgPSBwYXJzaW5nLnN1YnN0cmluZyhwYXJzaW5nLmluZGV4T2YoXCIgXCIpKTtcblxuICAgIGNvbnN0IG1lc3NhZ2UgPSBwYXJzaW5nLnN1YnN0cmluZygwLCBwYXJzaW5nLmluZGV4T2YoXCJcXG5cIikpO1xuICAgIHBhcnNpbmcgPSBwYXJzaW5nLnN1YnN0cmluZyhwYXJzaW5nLmluZGV4T2YoXCJcXG5cIikgKyAxKTtcblxuICAgIGNvbnN0IFtmcCwgbGluZSwgY29sdW1uLCBfXSA9IGZpbGVBbmRXaGVyZS5zcGxpdChcIjpcIik7XG4gICAgZmlsZV9wYXRoID0gZnA7XG4gICAgbWVzc2FnZXMucHVzaCh7XG4gICAgICBtZXNzYWdlOiBtZXNzYWdlLFxuICAgICAgbGluZTogTnVtYmVyKGxpbmUpIC0gMSxcbiAgICAgIGNvbHVtbjogTnVtYmVyKGNvbHVtbikgLSAxLFxuICAgICAgcnVsZUlkOiBudWxsLFxuICAgIH0gYXMgTGludE1lc3NhZ2UpO1xuICB9XG4gIHJlc3VsdHMucHVzaCh7XG4gICAgZmlsZVBhdGg6IGZpbGVfcGF0aCxcbiAgICBtZXNzYWdlczogbWVzc2FnZXMsXG4gICAgZXJyb3JDb3VudDogbWVzc2FnZXMubGVuZ3RoLFxuICAgIGZhdGFsRXJyb3JDb3VudDogMCxcbiAgICB3YXJuaW5nQ291bnQ6IDAsXG4gICAgZml4YWJsZUVycm9yQ291bnQ6IDAsXG4gICAgZml4YWJsZVdhcm5pbmdDb3VudDogMCxcbiAgfSBhcyBMaW50UmVzdWx0KTtcblxuICByZXR1cm4gZnJvbUxpbnRUb0xpbnRlcihyZXN1bHRzKTtcbn1cblxuZnVuY3Rpb24gZnJvbUxpbnRUb0xpbnRlcihyZXN1bHRzOiBMaW50UmVzdWx0W10pOiBQcm9taXNlPGFueVtdPiB7XG4gIGNvbnN0IHByb21pc2VzID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzdWx0cy5sZW5ndGg7ICsraSkge1xuICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVzdWx0c1tpXS5tZXNzYWdlcy5sZW5ndGg7ICsraikge1xuICAgICAgcHJvbWlzZXMucHVzaCh7XG4gICAgICAgIHNldmVyaXR5OiBcImVycm9yXCIsIC8vIHJlc3VsdHNbaV0ubWVzc2FnZXNbal0uc2V2ZXJpdHksXG4gICAgICAgIGV4Y2VycHQ6IHJlc3VsdHNbaV0ubWVzc2FnZXNbal0ubWVzc2FnZSxcbiAgICAgICAgbG9jYXRpb246IHtcbiAgICAgICAgICBmaWxlOiByZXN1bHRzW2ldLmZpbGVQYXRoLFxuICAgICAgICAgIHBvc2l0aW9uOiBnZW5lcmF0ZVJhbmdlKGVkaXRvciwgcmVzdWx0c1tpXS5tZXNzYWdlc1tqXS5saW5lLCByZXN1bHRzW2ldLm1lc3NhZ2VzW2pdLmNvbHVtbiksXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShwcm9taXNlcyk7XG59XG5cbmZ1bmN0aW9uIHdhaXRUb1JlYWR5KCk6IFByb21pc2U8YW55W10+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCBpZCA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgIGlmIChuZXh0X3JlYWR5IHx8IERhdGUubm93KCkgPiBzdGFydF90aW1lICsgMzAwMDApIHtcbiAgICAgICAgY2xlYXJJbnRlcnZhbChpZCk7XG4gICAgICAgIHJlc29sdmUocGFyc2VFcnJvcnNBc3luYygpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5cbmxldCBjdXJyZW50X2Vycm9ycyA9IFwiXCI7XG5sZXQgY3VycmVudF9yZXN1bHRzOiBQcm9taXNlPGFueVtdPiB8IG51bGwgPSBudWxsO1xuY29uc3QgY3VycmVudF9jb25maWcgPSBjb25maWc7XG5sZXQgcnVubmluZyA9IGZhbHNlO1xubGV0IGNoaWxkID0gbnVsbDtcblxuZnVuY3Rpb24gbG9nTm90aWZpY2F0aW9uKHRleHQsIHRpdHRsZSA9IFwiLS0gREVCVUcgLS1cIikge1xuICBjb25zdCBhcmdzID0geyBkaXNtaXNzYWJsZTogdGl0dGxlID09PSBcIi0tIERFQlVHIC0tXCIsIGRldGFpbDogdGV4dCB9O1xuICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkSW5mbyh0aXR0bGUsIGFyZ3MpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYWN0aXZhdGUoKSB7XG4gIGF0b20uY29tbWFuZHMuYWRkKFwiYXRvbS13b3Jrc3BhY2VcIiwge1xuICAgIFwiYXV0by1wcmV0dGllci1lc2xpbnQ6cnVuXCI6ICgpID0+IHtcbiAgICAgIHJ1bigpO1xuICAgIH0sXG4gIH0pO1xuXG4gIGF0b20ud29ya3NwYWNlLm9ic2VydmVUZXh0RWRpdG9ycygoZWRpdG9yKSA9PiB7XG4gICAgZWRpdG9yLm9uRGlkU2F2ZSgoKSA9PiB7XG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuY2xlYXIoKTtcbiAgICAgIGNvbnN0IGZpbGVzID0gZ2V0VmFsaWRGaWxlUGF0aHMoY3VycmVudF9jb25maWcucHJldHRpZXJGaWxlVHlwZS5nZXQoKSwgZ2V0Q3VycmVudEZpbGVQYXRoKCkpO1xuICAgICAgaWYgKGZpbGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgaWYgKHJ1bm5pbmcgJiYgY2hpbGQpIHtcbiAgICAgICAgY2hpbGQua2lsbCgpO1xuICAgICAgICBydW5uaW5nID0gZmFsc2U7XG4gICAgICB9XG4gICAgICBpZiAoIXJ1bm5pbmcpIHtcbiAgICAgICAgaWYgKGN1cnJlbnRfY29uZmlnLm5vdGlmaWNhdGlvbnMuZ2V0KCkpIHtcbiAgICAgICAgICBsb2dOb3RpZmljYXRpb24oXCJcIiwgXCJSdW5uaW5nIGF1dG8tcHJldHRpZXItZXNsaW50XCIpO1xuICAgICAgICB9XG4gICAgICAgIHJ1bm5pbmcgPSB0cnVlO1xuICAgICAgICBydW4oKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemUoKSB7fVxuXG5leHBvcnQgZnVuY3Rpb24gcnVuKCkge1xuICBleGVjUHJldHRpZXIoZ2V0Q3VycmVudEZpbGVQYXRoKCkpO1xufVxuXG5mdW5jdGlvbiBnZXRDdXJyZW50V29ya2luZ0RpcihmaWxlcGF0aCkge1xuICBsZXQgY3dkO1xuICBhdG9tLnByb2plY3QuZ2V0RGlyZWN0b3JpZXMoKS5mb3JFYWNoKGZ1bmN0aW9uIChkaXIpIHtcbiAgICBjb25zdCBkaXJwYXRoID0gZGlyLmdldFBhdGgoKTtcbiAgICBjb25zdCByZWxwYXRoID0gcGF0aC5yZWxhdGl2ZShkaXJwYXRoLCBmaWxlcGF0aCk7XG4gICAgY29uc3QgZGlySXNQYXJlbnQgPSAhL15cXC5cXC5cXC8vLnRlc3QocmVscGF0aCk7XG4gICAgaWYgKGRpcklzUGFyZW50KSB7XG4gICAgICBjd2QgPSBkaXJwYXRoO1xuICAgIH1cbiAgfSk7XG4gIGN3ZCA9IGN3ZCB8fCBwcm9jZXNzLmN3ZCgpO1xuICByZXR1cm4gY3dkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q3VycmVudEZpbGVQYXRoKCkge1xuICAvLyBAdHMtZXhwZWN0LWVycm9yXG4gIHJldHVybiBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVQYW5lSXRlbSgpLmdldFBhdGgoKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFBhdGhUb0VTTGludChjd2QpIHtcbiAgaWYgKGN1cnJlbnRfY29uZmlnLmVzbGludFBhdGguZ2V0KCkpIHtcbiAgICByZXR1cm4gY3VycmVudF9jb25maWcuZXNsaW50UGF0aC5nZXQoKTtcbiAgfVxuICBpZiAoZnMuZXhpc3RzU3luYyhgJHtjd2R9L25vZGVfbW9kdWxlcy8uYmluL2VzbGludGApKSB7XG4gICAgcmV0dXJuIFwiLi9ub2RlX21vZHVsZXMvLmJpbi9lc2xpbnRcIjtcbiAgfVxuICByZXR1cm4gXCJlc2xpbnRcIjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFBhdGhUb1ByZXR0aWVyKGN3ZCkge1xuICBpZiAoY3VycmVudF9jb25maWcucHJldHRpZXJQYXRoLmdldCgpKSB7XG4gICAgcmV0dXJuIGN1cnJlbnRfY29uZmlnLnByZXR0aWVyUGF0aC5nZXQoKTtcbiAgfVxuICBpZiAoZnMuZXhpc3RzU3luYyhgJHtjd2R9L25vZGVfbW9kdWxlcy8uYmluL3ByZXR0aWVyYCkpIHtcbiAgICByZXR1cm4gXCIuL25vZGVfbW9kdWxlcy8uYmluL3ByZXR0aWVyXCI7XG4gIH1cbiAgcmV0dXJuIFwicHJldHRpZXJcIjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFZhbGlkRmlsZVBhdGhzKGZpbGVUeXBlLCBmaWxlcGF0aCkge1xuICBjb25zdCBmaWxlcyA9IFtdO1xuICBjb25zdCBwYXRocyA9IGZpbGVwYXRoIGluc3RhbmNlb2YgQXJyYXkgPyBmaWxlcGF0aC5zbGljZSgpIDogW2ZpbGVwYXRoXTtcbiAgY29uc3QgcmV4ID0gbmV3IFJlZ0V4cChcIlxcXFwuKFwiICsgZmlsZVR5cGUucmVwbGFjZSgvXFxzKixcXHMqL2csIFwifFwiKSArIFwiKSRcIik7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcGF0aHMubGVuZ3RoOyArK2kpIHtcbiAgICBpZiAocmV4LnRlc3QocGF0aHNbaV0pKSB7XG4gICAgICBmaWxlcy5wdXNoKHBhdGhzW2ldKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGZpbGVzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXhlY1ByZXR0aWVyKGZpbGVwYXRoKSB7XG4gIGNvbnN0IGFyZ3MgPSBnZXRWYWxpZEZpbGVQYXRocyhjdXJyZW50X2NvbmZpZy5wcmV0dGllckZpbGVUeXBlLmdldCgpLCBmaWxlcGF0aCk7XG4gIGlmIChhcmdzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJ1bm5pbmcgPSBmYWxzZTtcbiAgICByZXR1cm47XG4gIH1cbiAgYXJncy51bnNoaWZ0KFwiLXdcIik7XG4gIGFyZ3MudW5zaGlmdChcIi0tY2FjaGVcIik7XG4gIGNvbnN0IGN3ZCA9IGdldEN1cnJlbnRXb3JraW5nRGlyKGZpbGVwYXRoKTtcbiAgY29uc3QgcnVubmVyID0gZ2V0UGF0aFRvUHJldHRpZXIoY3dkKTtcbiAgY2xpRXhlYyhjd2QsIHJ1bm5lciwgYXJncywgKCkgPT4ge1xuICAgIGV4ZWNFc2xpbnQoZmlsZXBhdGgpO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV4ZWNFc2xpbnQoZmlsZXBhdGgpIHtcbiAgY29uc3QgYXJncyA9IGdldFZhbGlkRmlsZVBhdGhzKGN1cnJlbnRfY29uZmlnLmVzbGludEZpbGVUeXBlLmdldCgpLCBmaWxlcGF0aCk7XG4gIGlmIChhcmdzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJ1bm5pbmcgPSBmYWxzZTtcbiAgICByZXR1cm47XG4gIH1cbiAgYXJncy51bnNoaWZ0KFwiLS1maXhcIik7XG4gIGFyZ3MudW5zaGlmdChcIi0tY2FjaGVcIik7XG4gIGFyZ3MudW5zaGlmdChcIi0tbm8taWdub3JlXCIpO1xuICBhcmdzLnVuc2hpZnQoXCItLWZvcm1hdD11bml4XCIpO1xuXG4gIGNvbnN0IGN3ZCA9IGdldEN1cnJlbnRXb3JraW5nRGlyKGZpbGVwYXRoKTtcbiAgY29uc3QgcnVubmVyID0gZ2V0UGF0aFRvRVNMaW50KGN3ZCk7XG4gIGNsaUV4ZWMoY3dkLCBydW5uZXIsIGFyZ3MsICgpID0+IHt9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsaUV4ZWMoY3dkLCBydW5uZXIsIGFyZywgY2FsbGJhY2spIHtcbiAgaWYgKHJ1bm5lci5pbmNsdWRlcyhcImVzbGludFwiKSkge1xuICAgIC8vIGNvbnN0IGZpbGUgPSBhcmdbYXJnLmxlbmd0aCAtIDFdO1xuICAgIC8vIGNvbnN0IHBhcnNlRXJyb3JzQXN5bmMgPSAocmVzdWx0OiBhbnlbXSkgPT4ge1xuICAgIC8vICAgICBjb25zdCByZXN1bHQyID0gY2xpRW5naW5lLmxpbnRGaWxlcyhmaWxlKSBhcyBhbnkgYXMgTGludFJlc3VsdFtdO1xuICAgIC8vICAgICByZXR1cm4gcmVzdWx0LmNvbmNhdChyZXN1bHQyKTtcbiAgICAvLyAgIH07XG4gICAgLy9cbiAgICAvLyBpZiAoY3VycmVudF9yZXN1bHRzICE9IG51bGwpIHtcbiAgICAvLyAgIGN1cnJlbnRfcmVzdWx0cy50aGVuKHBhcnNlRXJyb3JzQXN5bmMpO1xuICAgIC8vIH1cbiAgfVxuXG4gIGNoaWxkID0gZXhlY0ZpbGUocnVubmVyLCBhcmcsIHsgY3dkLCBzaGVsbDogZmFsc2UgfSwgKGVycm9yLCBzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgIGNvbnN0IG91dCA9IHN0ZG91dDtcbiAgICBjb25zdCBlcnIgPSBzdGRlcnI7XG4gICAgY29uc3QgYXJncyA9IHsgZGV0YWlsOiBlcnIgPyBlcnIgKyBcIlxcblwiICsgb3V0IDogb3V0LCBkaXNtaXNzYWJsZTogZmFsc2UgfTtcbiAgICBjb25zdCBub3RpZiA9IGVycm9yID8gY3VycmVudF9jb25maWcuemVycm9yLmdldCgpIDogY3VycmVudF9jb25maWcueXN1Y2Nlc3MuZ2V0KCk7XG4gICAgaWYgKGN1cnJlbnRfY29uZmlnLm5vdGlmaWNhdGlvbnMuZ2V0KCkpIHtcbiAgICAgIGxvZ05vdGlmaWNhdGlvbihcIlwiLCBydW5uZXIgKyBcIiBjb21wbGVhdGVkXCIpO1xuICAgIH1cbiAgICBpZiAocnVubmVyLmluY2x1ZGVzKFwiZXNsaW50XCIpKSB7XG4gICAgICBjdXJyZW50X2Vycm9ycyA9IG91dDtcbiAgICAgIGlmIChjdXJyZW50X3Jlc3VsdHMgIT0gbnVsbCkge1xuICAgICAgICBjdXJyZW50X3Jlc3VsdHMudGhlbihwYXJzZUVycm9yc0FzeW5jKTtcbiAgICAgIH1cbiAgICAgIG5leHRfcmVhZHkgPSB0cnVlO1xuICAgIH1cbiAgICBydW5uaW5nID0gZmFsc2U7XG4gICAgY2hpbGQgPSBudWxsO1xuICAgIGNhbGxiYWNrKCk7XG4gICAgLy8gbm90aWZpY2F0aW9ucyBoYW5kbGVcbiAgICBpZiAobm90aWYudHlwZSA9PT0gXCJub25lXCIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKG5vdGlmLnR5cGUgPT09IFwiZGlzbWlzc2FibGVcIiAmJiBlcnIubGVuZ3RoICsgb3V0Lmxlbmd0aCA+IDApIHtcbiAgICAgIGFyZ3MuZGlzbWlzc2FibGUgPSB0cnVlO1xuICAgIH1cbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihydW5uZXIgKyBcIiBmYWlsZWRcIiwgYXJncyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRTdWNjZXNzKHJ1bm5lciArIFwiIHN1Y2Nlc3NmdWxcIiwgYXJncyk7XG4gICAgfVxuICB9KTtcbn1cbi8vXG4vLyBleHBvcnQgZnVuY3Rpb24gcHJvdmlkZUxpbnRlcigpIHtcbi8vICAgcmV0dXJuIHtcbi8vICAgICBuYW1lOiBcIkVzbGludFwiLFxuLy8gICAgIGdyYW1tYXJTY29wZXM6IFtcInNvdXJjZS50c1wiXSxcbi8vICAgICBzY29wZTogXCJmaWxlXCIsXG4vLyAgICAgbGludHNPbkNoYW5nZTogZmFsc2UsXG4vLyAgICAgbGludDogKGVkaXRvcikgPT4ge1xuLy8gICAgICAgbGV0IHByb21pc2VzID0gW107XG4vLyAgICAgICBsZXQgcGFyc2luZyA9IGN1cnJlbnRfZXJyb3JzO1xuLy8gICAgICAgd2hpbGUgKHBhcnNpbmcubGVuZ3RoID4gMCAmJiBwYXJzaW5nLmluZGV4T2YoXCJcXG5cIikgIT09IDApIHtcbi8vICAgICAgICAgY29uc3QgZmlsZUFuZFdoZXJlID0gcGFyc2luZy5zdWJzdHJpbmcoMCwgcGFyc2luZy5pbmRleE9mKFwiIFwiKSk7XG4vLyAgICAgICAgIHBhcnNpbmcgPSBwYXJzaW5nLnN1YnN0cmluZyhwYXJzaW5nLmluZGV4T2YoXCIgXCIpKTtcbi8vXG4vLyAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBwYXJzaW5nLnN1YnN0cmluZygwLCBwYXJzaW5nLmluZGV4T2YoXCJcXG5cIikpO1xuLy8gICAgICAgICBwYXJzaW5nID0gcGFyc2luZy5zdWJzdHJpbmcocGFyc2luZy5pbmRleE9mKFwiXFxuXCIpKTtcbi8vXG4vLyAgICAgICAgIGNvbnN0IFtwYXRoLCBsaW5lLCBjb2x1bW4sIGR1bW15XSA9IGZpbGVBbmRXaGVyZS5zcGxpdChcIjpcIik7XG4vL1xuLy8gICAgICAgICBwcm9taXNlcy5wdXNoKHtcbi8vICAgICAgICAgICBzZXZlcml0eTogXCJlcnJvclwiLFxuLy8gICAgICAgICAgIGV4Y2VycHQ6IG1lc3NhZ2UsXG4vLyAgICAgICAgICAgbG9jYXRpb246IHtcbi8vICAgICAgICAgICAgIGZpbGU6IHBhdGgsXG4vLyAgICAgICAgICAgICBwb3NpdGlvbjogZ2VuZXJhdGVSYW5nZShlZGl0b3IsIE51bWJlcihsaW5lKSAtIDEsIE51bWJlcihjb2x1bW4pIC0gMSksXG4vLyAgICAgICAgICAgfSxcbi8vICAgICAgICAgfSk7XG4vLyAgICAgICB9XG4vLyAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHByb21pc2VzKTtcbi8vICAgICB9LFxuLy8gICB9O1xuLy8gfVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvdmlkZUxpbnRlcigpIHtcbiAgcmV0dXJuIHtcbiAgICBuYW1lOiBcIkVzbGludFwiLFxuICAgIGdyYW1tYXJTY29wZXM6IFtcInNvdXJjZS50c1wiXSxcbiAgICBzY29wZTogXCJmaWxlXCIsXG4gICAgbGludHNPbkNoYW5nZTogZmFsc2UsXG4gICAgbGludDogKGN1cnJlbnRfZWRpdG9yKTogUHJvbWlzZTxhbnlbXT4gPT4ge1xuICAgICAgZWRpdG9yID0gY3VycmVudF9lZGl0b3I7XG4gICAgICBuZXh0X3JlYWR5ID0gZmFsc2U7XG4gICAgICBzdGFydF90aW1lID0gRGF0ZS5ub3coKTtcbiAgICAgIGN1cnJlbnRfcmVzdWx0cyA9IHdhaXRUb1JlYWR5KCk7XG4gICAgICByZXR1cm4gY3VycmVudF9yZXN1bHRzO1xuICAgIH0sXG4gIH07XG59XG4iXX0=