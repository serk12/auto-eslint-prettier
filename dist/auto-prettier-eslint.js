"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.provideLinter = exports.cliExec = exports.execEslint = exports.execPrettier = exports.getValidFilePaths = exports.getPathToPrettier = exports.getPathToESLint = exports.getCurrentFilePath = exports.run = exports.serialize = exports.activate = exports.config = void 0;
const child_process_1 = require("child_process");
const config_js_1 = __importDefault(require("./config.js"));
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const atom_linter_1 = require("atom-linter");
const eslint_1 = __importDefault(require("eslint"));
const cliEngine = new eslint_1.default.ESLint({});
function bytes2String(bytes) {
    let result = "";
    for (let i = 0; i < bytes.length; i++) {
        result += String.fromCharCode(bytes[i]);
    }
    return result;
}
exports.config = config_js_1.default;
let next_ready = false;
let start_time = Date.now();
async function waitToReady() {
    async function checkReady() {
        if (!(next_ready || Date.now() > start_time + 300000)) {
            await window.setTimeout(checkReady, 1000);
        }
        else {
        }
    }
    await checkReady();
    return [];
}
let current_errors = "";
let current_results = new Promise(() => {
    waitToReady();
    return [];
});
const current_config = exports.config;
let running = false;
let child = null;
function logNotification(text, tittle = "-- DEBUG --") {
    const args = { dismissable: tittle === "-- DEBUG --", detail: text };
    atom.notifications.addInfo(tittle, args);
}
function activate() {
    atom.commands.add("atom-workspace", {
        "auto-prettier-eslint:run": () => {
            run();
        },
    });
    atom.workspace.observeTextEditors((editor) => {
        editor.onDidSave(() => {
            atom.notifications.clear();
            const files = getValidFilePaths(current_config.prettierFileType.get(), getCurrentFilePath());
            if (files.length === 0)
                return;
            if (running && child) {
                child.kill();
                running = false;
            }
            if (!running) {
                if (current_config.notifications.get()) {
                    logNotification("", "Running auto-prettier-eslint");
                }
                running = true;
                run();
            }
        });
    });
}
exports.activate = activate;
function serialize() { }
exports.serialize = serialize;
function run() {
    execPrettier(getCurrentFilePath());
}
exports.run = run;
function getCurrentWorkingDir(filepath) {
    let cwd;
    atom.project.getDirectories().forEach(function (dir) {
        const dirpath = dir.getPath();
        const relpath = path_1.default.relative(dirpath, filepath);
        const dirIsParent = !/^\.\.\//.test(relpath);
        if (dirIsParent) {
            cwd = dirpath;
        }
    });
    cwd = cwd || process.cwd();
    return cwd;
}
function getCurrentFilePath() {
    return atom.workspace.getActivePaneItem().getPath();
}
exports.getCurrentFilePath = getCurrentFilePath;
function getPathToESLint(cwd) {
    if (current_config.eslintPath.get()) {
        return current_config.eslintPath.get();
    }
    if (fs_1.default.existsSync(`${cwd}/node_modules/.bin/eslint`)) {
        return "./node_modules/.bin/eslint";
    }
    return "eslint";
}
exports.getPathToESLint = getPathToESLint;
function getPathToPrettier(cwd) {
    if (current_config.prettierPath.get()) {
        return current_config.prettierPath.get();
    }
    if (fs_1.default.existsSync(`${cwd}/node_modules/.bin/prettier`)) {
        return "./node_modules/.bin/prettier";
    }
    return "prettier";
}
exports.getPathToPrettier = getPathToPrettier;
function getValidFilePaths(fileType, filepath) {
    const files = [];
    const paths = filepath instanceof Array ? filepath.slice() : [filepath];
    const rex = new RegExp("\\.(" + fileType.replace(/\s*,\s*/g, "|") + ")$");
    for (let i = 0; i < paths.length; ++i) {
        if (rex.test(paths[i])) {
            files.push(paths[i]);
        }
    }
    return files;
}
exports.getValidFilePaths = getValidFilePaths;
function execPrettier(filepath) {
    const args = getValidFilePaths(current_config.prettierFileType.get(), filepath);
    if (args.length === 0) {
        running = false;
        return;
    }
    args.unshift("-w");
    args.unshift("--cache");
    const cwd = getCurrentWorkingDir(filepath);
    const runner = getPathToPrettier(cwd);
    cliExec(cwd, runner, args, () => {
        execEslint(filepath);
    });
}
exports.execPrettier = execPrettier;
function execEslint(filepath) {
    const args = getValidFilePaths(current_config.eslintFileType.get(), filepath);
    if (args.length === 0) {
        running = false;
        return;
    }
    args.unshift("--fix");
    args.unshift("--cache");
    args.unshift("--no-ignore");
    args.unshift("--format=unix");
    const cwd = getCurrentWorkingDir(filepath);
    const runner = getPathToESLint(cwd);
    cliExec(cwd, runner, args, () => { });
}
exports.execEslint = execEslint;
function cliExec(cwd, runner, arg, callback) {
    if (runner.includes("eslint")) {
        const file = arg[arg.length - 1];
    }
    child = (0, child_process_1.execFile)(runner, arg, { cwd, shell: false }, (error, stdout, stderr) => {
        const out = stdout;
        const err = stderr;
        const args = { detail: err ? err + "\n" + out : out, dismissable: false };
        const notif = error ? current_config.zerror.get() : current_config.ysuccess.get();
        if (current_config.notifications.get()) {
            logNotification("", runner + " compleated");
        }
        if (runner.includes("eslint")) {
            current_errors = out;
            current_results.then((results) => {
                let parsing = out;
                const messages = [];
                let file_path = "";
                while (parsing.length > 0 && parsing.indexOf("\n") !== 0) {
                    const fileAndWhere = parsing.substring(0, parsing.indexOf(" "));
                    parsing = parsing.substring(parsing.indexOf(" "));
                    const message = parsing.substring(0, parsing.indexOf("\n"));
                    parsing = parsing.substring(parsing.indexOf("\n"));
                    const [fp, line, column, _] = fileAndWhere.split(":");
                    file_path = fp;
                    messages.push({
                        message: message,
                        line: Number(column) - 1,
                        column: Number(line) - 1,
                        ruleId: null,
                    });
                }
                results.push({
                    filePath: file_path,
                    messages: messages,
                    errorCount: messages.length,
                    fatalErrorCount: 0,
                    warningCount: 0,
                    fixableErrorCount: 0,
                    fixableWarningCount: 0,
                });
                return results;
            });
            next_ready = true;
        }
        running = false;
        child = null;
        callback();
        if (notif.type === "none") {
            return;
        }
        else if (notif.type === "dismissable" && err.length + out.length > 0) {
            args.dismissable = true;
        }
        if (error) {
            atom.notifications.addError(runner + " failed", args);
        }
        else {
            atom.notifications.addSuccess(runner + " successful", args);
        }
    });
}
exports.cliExec = cliExec;
function provideLinter() {
    return {
        name: "Eslint",
        grammarScopes: ["source.ts"],
        scope: "file",
        lintsOnChange: false,
        lint: (editor) => {
            let promises = [];
            let parsing = current_errors;
            while (parsing.length > 0 && parsing.indexOf("\n") !== 0) {
                const fileAndWhere = parsing.substring(0, parsing.indexOf(" "));
                parsing = parsing.substring(parsing.indexOf(" "));
                const message = parsing.substring(0, parsing.indexOf("\n"));
                parsing = parsing.substring(parsing.indexOf("\n"));
                const [path, line, column, dummy] = fileAndWhere.split(":");
                promises.push({
                    severity: "error",
                    excerpt: message,
                    location: {
                        file: path,
                        position: (0, atom_linter_1.generateRange)(editor, Number(line) - 1, Number(column) - 1),
                    },
                });
            }
            return Promise.resolve(promises);
        },
    };
}
exports.provideLinter = provideLinter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0by1wcmV0dGllci1lc2xpbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvYXV0by1wcmV0dGllci1lc2xpbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7Ozs7QUFFYixpREFBeUM7QUFDekMsNERBQWlDO0FBQ2pDLGdEQUF3QjtBQUN4Qiw0Q0FBb0I7QUFDcEIsNkNBQTRDO0FBRTVDLG9EQUE0QjtBQUU1QixNQUFNLFNBQVMsR0FBa0IsSUFBSSxnQkFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUV2RCxTQUFTLFlBQVksQ0FBQyxLQUFLO0lBQ3pCLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztJQUNoQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3RDLE1BQU0sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFDRCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDO0FBRVksUUFBQSxNQUFNLEdBQUcsbUJBQU0sQ0FBQztBQUM3QixJQUFJLFVBQVUsR0FBRyxLQUFLLENBQUM7QUFDdkIsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBRTVCLEtBQUssVUFBVSxXQUFXO0lBQ3hCLEtBQUssVUFBVSxVQUFVO1FBQ3ZCLElBQUksQ0FBQyxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsVUFBVSxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDdEQsTUFBTSxNQUFNLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM1QyxDQUFDO2FBQU0sQ0FBQztRQUNSLENBQUM7SUFDSCxDQUFDO0lBRUQsTUFBTSxVQUFVLEVBQUUsQ0FBQztJQUNuQixPQUFPLEVBQUUsQ0FBQztBQUNaLENBQUM7QUFFRCxJQUFJLGNBQWMsR0FBRyxFQUFFLENBQUM7QUFDeEIsSUFBSSxlQUFlLEdBQTBCLElBQUksT0FBTyxDQUFDLEdBQUcsRUFBRTtJQUM1RCxXQUFXLEVBQUUsQ0FBQztJQUNkLE9BQU8sRUFBRSxDQUFDO0FBQ1osQ0FBQyxDQUFDLENBQUM7QUFDSCxNQUFNLGNBQWMsR0FBRyxjQUFNLENBQUM7QUFDOUIsSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFDO0FBQ3BCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztBQUVqQixTQUFTLGVBQWUsQ0FBQyxJQUFJLEVBQUUsTUFBTSxHQUFHLGFBQWE7SUFDbkQsTUFBTSxJQUFJLEdBQUcsRUFBRSxXQUFXLEVBQUUsTUFBTSxLQUFLLGFBQWEsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUM7SUFDckUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQzNDLENBQUM7QUFFRCxTQUFnQixRQUFRO0lBQ3RCLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFO1FBQ2xDLDBCQUEwQixFQUFFLEdBQUcsRUFBRTtZQUMvQixHQUFHLEVBQUUsQ0FBQztRQUNSLENBQUM7S0FDRixDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7UUFDM0MsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7WUFDcEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUMzQixNQUFNLEtBQUssR0FBRyxpQkFBaUIsQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO1lBQzdGLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDO2dCQUFFLE9BQU87WUFDL0IsSUFBSSxPQUFPLElBQUksS0FBSyxFQUFFLENBQUM7Z0JBQ3JCLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDYixPQUFPLEdBQUcsS0FBSyxDQUFDO1lBQ2xCLENBQUM7WUFDRCxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ2IsSUFBSSxjQUFjLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7b0JBQ3ZDLGVBQWUsQ0FBQyxFQUFFLEVBQUUsOEJBQThCLENBQUMsQ0FBQztnQkFDdEQsQ0FBQztnQkFDRCxPQUFPLEdBQUcsSUFBSSxDQUFDO2dCQUNmLEdBQUcsRUFBRSxDQUFDO1lBQ1IsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBekJELDRCQXlCQztBQUVELFNBQWdCLFNBQVMsS0FBSSxDQUFDO0FBQTlCLDhCQUE4QjtBQUU5QixTQUFnQixHQUFHO0lBQ2pCLFlBQVksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDLENBQUM7QUFDckMsQ0FBQztBQUZELGtCQUVDO0FBRUQsU0FBUyxvQkFBb0IsQ0FBQyxRQUFRO0lBQ3BDLElBQUksR0FBRyxDQUFDO0lBQ1IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FBQyxPQUFPLENBQUMsVUFBVSxHQUFHO1FBQ2pELE1BQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM5QixNQUFNLE9BQU8sR0FBRyxjQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNqRCxNQUFNLFdBQVcsR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDN0MsSUFBSSxXQUFXLEVBQUUsQ0FBQztZQUNoQixHQUFHLEdBQUcsT0FBTyxDQUFDO1FBQ2hCLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUNILEdBQUcsR0FBRyxHQUFHLElBQUksT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzNCLE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQztBQUVELFNBQWdCLGtCQUFrQjtJQUVoQyxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN0RCxDQUFDO0FBSEQsZ0RBR0M7QUFFRCxTQUFnQixlQUFlLENBQUMsR0FBRztJQUNqQyxJQUFJLGNBQWMsQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQztRQUNwQyxPQUFPLGNBQWMsQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDekMsQ0FBQztJQUNELElBQUksWUFBRSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEdBQUcsMkJBQTJCLENBQUMsRUFBRSxDQUFDO1FBQ3JELE9BQU8sNEJBQTRCLENBQUM7SUFDdEMsQ0FBQztJQUNELE9BQU8sUUFBUSxDQUFDO0FBQ2xCLENBQUM7QUFSRCwwQ0FRQztBQUVELFNBQWdCLGlCQUFpQixDQUFDLEdBQUc7SUFDbkMsSUFBSSxjQUFjLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7UUFDdEMsT0FBTyxjQUFjLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzNDLENBQUM7SUFDRCxJQUFJLFlBQUUsQ0FBQyxVQUFVLENBQUMsR0FBRyxHQUFHLDZCQUE2QixDQUFDLEVBQUUsQ0FBQztRQUN2RCxPQUFPLDhCQUE4QixDQUFDO0lBQ3hDLENBQUM7SUFDRCxPQUFPLFVBQVUsQ0FBQztBQUNwQixDQUFDO0FBUkQsOENBUUM7QUFFRCxTQUFnQixpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsUUFBUTtJQUNsRCxNQUFNLEtBQUssR0FBRyxFQUFFLENBQUM7SUFDakIsTUFBTSxLQUFLLEdBQUcsUUFBUSxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3hFLE1BQU0sR0FBRyxHQUFHLElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUMxRSxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQ3RDLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQ3ZCLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkIsQ0FBQztJQUNILENBQUM7SUFDRCxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUM7QUFWRCw4Q0FVQztBQUVELFNBQWdCLFlBQVksQ0FBQyxRQUFRO0lBQ25DLE1BQU0sSUFBSSxHQUFHLGlCQUFpQixDQUFDLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNoRixJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDdEIsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUNoQixPQUFPO0lBQ1QsQ0FBQztJQUNELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN4QixNQUFNLEdBQUcsR0FBRyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMzQyxNQUFNLE1BQU0sR0FBRyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN0QyxPQUFPLENBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFO1FBQzlCLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN2QixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFiRCxvQ0FhQztBQUVELFNBQWdCLFVBQVUsQ0FBQyxRQUFRO0lBQ2pDLE1BQU0sSUFBSSxHQUFHLGlCQUFpQixDQUFDLGNBQWMsQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDOUUsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQ3RCLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDaEIsT0FBTztJQUNULENBQUM7SUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3RCLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDeEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUM1QixJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBRTlCLE1BQU0sR0FBRyxHQUFHLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzNDLE1BQU0sTUFBTSxHQUFHLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwQyxPQUFPLENBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUUsQ0FBQyxDQUFDLENBQUM7QUFDdkMsQ0FBQztBQWRELGdDQWNDO0FBRUQsU0FBZ0IsT0FBTyxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFFBQVE7SUFDaEQsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7UUFDOUIsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFVbkMsQ0FBQztJQUVELEtBQUssR0FBRyxJQUFBLHdCQUFRLEVBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxFQUFFO1FBQzdFLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQztRQUNuQixNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUM7UUFDbkIsTUFBTSxJQUFJLEdBQUcsRUFBRSxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsQ0FBQztRQUMxRSxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDbEYsSUFBSSxjQUFjLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7WUFDdkMsZUFBZSxDQUFDLEVBQUUsRUFBRSxNQUFNLEdBQUcsYUFBYSxDQUFDLENBQUM7UUFDOUMsQ0FBQztRQUNELElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO1lBQzlCLGNBQWMsR0FBRyxHQUFHLENBQUM7WUFDckIsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUMvQixJQUFJLE9BQU8sR0FBRyxHQUFHLENBQUM7Z0JBQ2xCLE1BQU0sUUFBUSxHQUFrQixFQUFFLENBQUM7Z0JBQ25DLElBQUksU0FBUyxHQUFHLEVBQUUsQ0FBQztnQkFDbkIsT0FBTyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO29CQUN6RCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBQ2hFLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFFbEQsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO29CQUM1RCxPQUFPLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBRW5ELE1BQU0sQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUN0RCxTQUFTLEdBQUcsRUFBRSxDQUFDO29CQUNmLFFBQVEsQ0FBQyxJQUFJLENBQUM7d0JBQ1osT0FBTyxFQUFFLE9BQU87d0JBQ2hCLElBQUksRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQzt3QkFDeEIsTUFBTSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO3dCQUN4QixNQUFNLEVBQUUsSUFBSTtxQkFDRSxDQUFDLENBQUM7Z0JBQ3BCLENBQUM7Z0JBQ0QsT0FBTyxDQUFDLElBQUksQ0FBQztvQkFDWCxRQUFRLEVBQUUsU0FBUztvQkFDbkIsUUFBUSxFQUFFLFFBQVE7b0JBQ2xCLFVBQVUsRUFBRSxRQUFRLENBQUMsTUFBTTtvQkFDM0IsZUFBZSxFQUFFLENBQUM7b0JBQ2xCLFlBQVksRUFBRSxDQUFDO29CQUNmLGlCQUFpQixFQUFFLENBQUM7b0JBQ3BCLG1CQUFtQixFQUFFLENBQUM7aUJBQ1QsQ0FBQyxDQUFDO2dCQUNqQixPQUFPLE9BQU8sQ0FBQztZQUNqQixDQUFDLENBQUMsQ0FBQztZQUNILFVBQVUsR0FBRyxJQUFJLENBQUM7UUFDcEIsQ0FBQztRQUNELE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDaEIsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNiLFFBQVEsRUFBRSxDQUFDO1FBRVgsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRSxDQUFDO1lBQzFCLE9BQU87UUFDVCxDQUFDO2FBQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLGFBQWEsSUFBSSxHQUFHLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDdkUsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDMUIsQ0FBQztRQUNELElBQUksS0FBSyxFQUFFLENBQUM7WUFDVixJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3hELENBQUM7YUFBTSxDQUFDO1lBQ04sSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM5RCxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBeEVELDBCQXdFQztBQUVELFNBQWdCLGFBQWE7SUFDM0IsT0FBTztRQUNMLElBQUksRUFBRSxRQUFRO1FBQ2QsYUFBYSxFQUFFLENBQUMsV0FBVyxDQUFDO1FBQzVCLEtBQUssRUFBRSxNQUFNO1FBQ2IsYUFBYSxFQUFFLEtBQUs7UUFDcEIsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDZixJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUM7WUFDbEIsSUFBSSxPQUFPLEdBQUcsY0FBYyxDQUFDO1lBQzdCLE9BQU8sT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDekQsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUNoRSxPQUFPLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBRWxELE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDNUQsT0FBTyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUVuRCxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsS0FBSyxDQUFDLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFFNUQsUUFBUSxDQUFDLElBQUksQ0FBQztvQkFDWixRQUFRLEVBQUUsT0FBTztvQkFDakIsT0FBTyxFQUFFLE9BQU87b0JBQ2hCLFFBQVEsRUFBRTt3QkFDUixJQUFJLEVBQUUsSUFBSTt3QkFDVixRQUFRLEVBQUUsSUFBQSwyQkFBYSxFQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7cUJBQ3RFO2lCQUNGLENBQUMsQ0FBQztZQUNMLENBQUM7WUFDRCxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbkMsQ0FBQztLQUNGLENBQUM7QUFDSixDQUFDO0FBOUJELHNDQThCQyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgeyBleGVjRmlsZSB9IGZyb20gXCJjaGlsZF9wcm9jZXNzXCI7XG5pbXBvcnQgQ29uZmlnIGZyb20gXCIuL2NvbmZpZy5qc1wiO1xuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCB7IGdlbmVyYXRlUmFuZ2UgfSBmcm9tIFwiYXRvbS1saW50ZXJcIjtcbmltcG9ydCB7IExpbnRSZXN1bHQsIExpbnRNZXNzYWdlIH0gZnJvbSBcIi4vRVNsaW50VHlwZXMuZC5qc1wiO1xuaW1wb3J0IEVTTGludCBmcm9tIFwiZXNsaW50XCI7XG5cbmNvbnN0IGNsaUVuZ2luZTogRVNMaW50LkVTTGludCA9IG5ldyBFU0xpbnQuRVNMaW50KHt9KTtcblxuZnVuY3Rpb24gYnl0ZXMyU3RyaW5nKGJ5dGVzKSB7XG4gIGxldCByZXN1bHQgPSBcIlwiO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGJ5dGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgcmVzdWx0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnl0ZXNbaV0pO1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBjb25zdCBjb25maWcgPSBDb25maWc7XG5sZXQgbmV4dF9yZWFkeSA9IGZhbHNlO1xubGV0IHN0YXJ0X3RpbWUgPSBEYXRlLm5vdygpO1xuXG5hc3luYyBmdW5jdGlvbiB3YWl0VG9SZWFkeSgpIHtcbiAgYXN5bmMgZnVuY3Rpb24gY2hlY2tSZWFkeSgpIHtcbiAgICBpZiAoIShuZXh0X3JlYWR5IHx8IERhdGUubm93KCkgPiBzdGFydF90aW1lICsgMzAwMDAwKSkge1xuICAgICAgYXdhaXQgd2luZG93LnNldFRpbWVvdXQoY2hlY2tSZWFkeSwgMTAwMCk7XG4gICAgfSBlbHNlIHtcbiAgICB9XG4gIH1cblxuICBhd2FpdCBjaGVja1JlYWR5KCk7XG4gIHJldHVybiBbXTtcbn1cblxubGV0IGN1cnJlbnRfZXJyb3JzID0gXCJcIjtcbmxldCBjdXJyZW50X3Jlc3VsdHM6IFByb21pc2U8TGludFJlc3VsdFtdPiA9IG5ldyBQcm9taXNlKCgpID0+IHtcbiAgd2FpdFRvUmVhZHkoKTtcbiAgcmV0dXJuIFtdO1xufSk7XG5jb25zdCBjdXJyZW50X2NvbmZpZyA9IGNvbmZpZztcbmxldCBydW5uaW5nID0gZmFsc2U7XG5sZXQgY2hpbGQgPSBudWxsO1xuXG5mdW5jdGlvbiBsb2dOb3RpZmljYXRpb24odGV4dCwgdGl0dGxlID0gXCItLSBERUJVRyAtLVwiKSB7XG4gIGNvbnN0IGFyZ3MgPSB7IGRpc21pc3NhYmxlOiB0aXR0bGUgPT09IFwiLS0gREVCVUcgLS1cIiwgZGV0YWlsOiB0ZXh0IH07XG4gIGF0b20ubm90aWZpY2F0aW9ucy5hZGRJbmZvKHRpdHRsZSwgYXJncyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZSgpIHtcbiAgYXRvbS5jb21tYW5kcy5hZGQoXCJhdG9tLXdvcmtzcGFjZVwiLCB7XG4gICAgXCJhdXRvLXByZXR0aWVyLWVzbGludDpydW5cIjogKCkgPT4ge1xuICAgICAgcnVuKCk7XG4gICAgfSxcbiAgfSk7XG5cbiAgYXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZVRleHRFZGl0b3JzKChlZGl0b3IpID0+IHtcbiAgICBlZGl0b3Iub25EaWRTYXZlKCgpID0+IHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5jbGVhcigpO1xuICAgICAgY29uc3QgZmlsZXMgPSBnZXRWYWxpZEZpbGVQYXRocyhjdXJyZW50X2NvbmZpZy5wcmV0dGllckZpbGVUeXBlLmdldCgpLCBnZXRDdXJyZW50RmlsZVBhdGgoKSk7XG4gICAgICBpZiAoZmlsZXMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICBpZiAocnVubmluZyAmJiBjaGlsZCkge1xuICAgICAgICBjaGlsZC5raWxsKCk7XG4gICAgICAgIHJ1bm5pbmcgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmICghcnVubmluZykge1xuICAgICAgICBpZiAoY3VycmVudF9jb25maWcubm90aWZpY2F0aW9ucy5nZXQoKSkge1xuICAgICAgICAgIGxvZ05vdGlmaWNhdGlvbihcIlwiLCBcIlJ1bm5pbmcgYXV0by1wcmV0dGllci1lc2xpbnRcIik7XG4gICAgICAgIH1cbiAgICAgICAgcnVubmluZyA9IHRydWU7XG4gICAgICAgIHJ1bigpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlcmlhbGl6ZSgpIHt9XG5cbmV4cG9ydCBmdW5jdGlvbiBydW4oKSB7XG4gIGV4ZWNQcmV0dGllcihnZXRDdXJyZW50RmlsZVBhdGgoKSk7XG59XG5cbmZ1bmN0aW9uIGdldEN1cnJlbnRXb3JraW5nRGlyKGZpbGVwYXRoKSB7XG4gIGxldCBjd2Q7XG4gIGF0b20ucHJvamVjdC5nZXREaXJlY3RvcmllcygpLmZvckVhY2goZnVuY3Rpb24gKGRpcikge1xuICAgIGNvbnN0IGRpcnBhdGggPSBkaXIuZ2V0UGF0aCgpO1xuICAgIGNvbnN0IHJlbHBhdGggPSBwYXRoLnJlbGF0aXZlKGRpcnBhdGgsIGZpbGVwYXRoKTtcbiAgICBjb25zdCBkaXJJc1BhcmVudCA9ICEvXlxcLlxcLlxcLy8udGVzdChyZWxwYXRoKTtcbiAgICBpZiAoZGlySXNQYXJlbnQpIHtcbiAgICAgIGN3ZCA9IGRpcnBhdGg7XG4gICAgfVxuICB9KTtcbiAgY3dkID0gY3dkIHx8IHByb2Nlc3MuY3dkKCk7XG4gIHJldHVybiBjd2Q7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDdXJyZW50RmlsZVBhdGgoKSB7XG4gIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgcmV0dXJuIGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVBhbmVJdGVtKCkuZ2V0UGF0aCgpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGF0aFRvRVNMaW50KGN3ZCkge1xuICBpZiAoY3VycmVudF9jb25maWcuZXNsaW50UGF0aC5nZXQoKSkge1xuICAgIHJldHVybiBjdXJyZW50X2NvbmZpZy5lc2xpbnRQYXRoLmdldCgpO1xuICB9XG4gIGlmIChmcy5leGlzdHNTeW5jKGAke2N3ZH0vbm9kZV9tb2R1bGVzLy5iaW4vZXNsaW50YCkpIHtcbiAgICByZXR1cm4gXCIuL25vZGVfbW9kdWxlcy8uYmluL2VzbGludFwiO1xuICB9XG4gIHJldHVybiBcImVzbGludFwiO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGF0aFRvUHJldHRpZXIoY3dkKSB7XG4gIGlmIChjdXJyZW50X2NvbmZpZy5wcmV0dGllclBhdGguZ2V0KCkpIHtcbiAgICByZXR1cm4gY3VycmVudF9jb25maWcucHJldHRpZXJQYXRoLmdldCgpO1xuICB9XG4gIGlmIChmcy5leGlzdHNTeW5jKGAke2N3ZH0vbm9kZV9tb2R1bGVzLy5iaW4vcHJldHRpZXJgKSkge1xuICAgIHJldHVybiBcIi4vbm9kZV9tb2R1bGVzLy5iaW4vcHJldHRpZXJcIjtcbiAgfVxuICByZXR1cm4gXCJwcmV0dGllclwiO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VmFsaWRGaWxlUGF0aHMoZmlsZVR5cGUsIGZpbGVwYXRoKSB7XG4gIGNvbnN0IGZpbGVzID0gW107XG4gIGNvbnN0IHBhdGhzID0gZmlsZXBhdGggaW5zdGFuY2VvZiBBcnJheSA/IGZpbGVwYXRoLnNsaWNlKCkgOiBbZmlsZXBhdGhdO1xuICBjb25zdCByZXggPSBuZXcgUmVnRXhwKFwiXFxcXC4oXCIgKyBmaWxlVHlwZS5yZXBsYWNlKC9cXHMqLFxccyovZywgXCJ8XCIpICsgXCIpJFwiKTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXRocy5sZW5ndGg7ICsraSkge1xuICAgIGlmIChyZXgudGVzdChwYXRoc1tpXSkpIHtcbiAgICAgIGZpbGVzLnB1c2gocGF0aHNbaV0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmlsZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBleGVjUHJldHRpZXIoZmlsZXBhdGgpIHtcbiAgY29uc3QgYXJncyA9IGdldFZhbGlkRmlsZVBhdGhzKGN1cnJlbnRfY29uZmlnLnByZXR0aWVyRmlsZVR5cGUuZ2V0KCksIGZpbGVwYXRoKTtcbiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgcnVubmluZyA9IGZhbHNlO1xuICAgIHJldHVybjtcbiAgfVxuICBhcmdzLnVuc2hpZnQoXCItd1wiKTtcbiAgYXJncy51bnNoaWZ0KFwiLS1jYWNoZVwiKTtcbiAgY29uc3QgY3dkID0gZ2V0Q3VycmVudFdvcmtpbmdEaXIoZmlsZXBhdGgpO1xuICBjb25zdCBydW5uZXIgPSBnZXRQYXRoVG9QcmV0dGllcihjd2QpO1xuICBjbGlFeGVjKGN3ZCwgcnVubmVyLCBhcmdzLCAoKSA9PiB7XG4gICAgZXhlY0VzbGludChmaWxlcGF0aCk7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXhlY0VzbGludChmaWxlcGF0aCkge1xuICBjb25zdCBhcmdzID0gZ2V0VmFsaWRGaWxlUGF0aHMoY3VycmVudF9jb25maWcuZXNsaW50RmlsZVR5cGUuZ2V0KCksIGZpbGVwYXRoKTtcbiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgcnVubmluZyA9IGZhbHNlO1xuICAgIHJldHVybjtcbiAgfVxuICBhcmdzLnVuc2hpZnQoXCItLWZpeFwiKTtcbiAgYXJncy51bnNoaWZ0KFwiLS1jYWNoZVwiKTtcbiAgYXJncy51bnNoaWZ0KFwiLS1uby1pZ25vcmVcIik7XG4gIGFyZ3MudW5zaGlmdChcIi0tZm9ybWF0PXVuaXhcIik7XG5cbiAgY29uc3QgY3dkID0gZ2V0Q3VycmVudFdvcmtpbmdEaXIoZmlsZXBhdGgpO1xuICBjb25zdCBydW5uZXIgPSBnZXRQYXRoVG9FU0xpbnQoY3dkKTtcbiAgY2xpRXhlYyhjd2QsIHJ1bm5lciwgYXJncywgKCkgPT4ge30pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2xpRXhlYyhjd2QsIHJ1bm5lciwgYXJnLCBjYWxsYmFjaykge1xuICBpZiAocnVubmVyLmluY2x1ZGVzKFwiZXNsaW50XCIpKSB7XG4gICAgY29uc3QgZmlsZSA9IGFyZ1thcmcubGVuZ3RoIC0gMV07XG4gICAgLy8gY3VycmVudF9yZXN1bHRzXG4gICAgLy8gICAudGhlbihhc3luYyAocmVzdWx0KSA9PiB7XG4gICAgLy8gICAgIGNvbnN0IHJlc3VsdDIgPSBhd2FpdCBjbGlFbmdpbmUubGludEZpbGVzKGZpbGUpO1xuICAgIC8vICAgICByZXR1cm4gcmVzdWx0LmNvbmNhdChyZXN1bHQyKTtcbiAgICAvLyAgIH0pXG4gICAgLy8gICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgLy8gICAgIGxvZ05vdGlmaWNhdGlvbihcIlwiLCBcIkVycm9yOiBcIiArIFN0cmluZyhlcnJvcikpO1xuICAgIC8vICAgICByZXR1cm4gW107XG4gICAgLy8gICB9KTtcbiAgfVxuXG4gIGNoaWxkID0gZXhlY0ZpbGUocnVubmVyLCBhcmcsIHsgY3dkLCBzaGVsbDogZmFsc2UgfSwgKGVycm9yLCBzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgIGNvbnN0IG91dCA9IHN0ZG91dDtcbiAgICBjb25zdCBlcnIgPSBzdGRlcnI7XG4gICAgY29uc3QgYXJncyA9IHsgZGV0YWlsOiBlcnIgPyBlcnIgKyBcIlxcblwiICsgb3V0IDogb3V0LCBkaXNtaXNzYWJsZTogZmFsc2UgfTtcbiAgICBjb25zdCBub3RpZiA9IGVycm9yID8gY3VycmVudF9jb25maWcuemVycm9yLmdldCgpIDogY3VycmVudF9jb25maWcueXN1Y2Nlc3MuZ2V0KCk7XG4gICAgaWYgKGN1cnJlbnRfY29uZmlnLm5vdGlmaWNhdGlvbnMuZ2V0KCkpIHtcbiAgICAgIGxvZ05vdGlmaWNhdGlvbihcIlwiLCBydW5uZXIgKyBcIiBjb21wbGVhdGVkXCIpO1xuICAgIH1cbiAgICBpZiAocnVubmVyLmluY2x1ZGVzKFwiZXNsaW50XCIpKSB7XG4gICAgICBjdXJyZW50X2Vycm9ycyA9IG91dDtcbiAgICAgIGN1cnJlbnRfcmVzdWx0cy50aGVuKChyZXN1bHRzKSA9PiB7XG4gICAgICAgIGxldCBwYXJzaW5nID0gb3V0O1xuICAgICAgICBjb25zdCBtZXNzYWdlczogTGludE1lc3NhZ2VbXSA9IFtdO1xuICAgICAgICBsZXQgZmlsZV9wYXRoID0gXCJcIjtcbiAgICAgICAgd2hpbGUgKHBhcnNpbmcubGVuZ3RoID4gMCAmJiBwYXJzaW5nLmluZGV4T2YoXCJcXG5cIikgIT09IDApIHtcbiAgICAgICAgICBjb25zdCBmaWxlQW5kV2hlcmUgPSBwYXJzaW5nLnN1YnN0cmluZygwLCBwYXJzaW5nLmluZGV4T2YoXCIgXCIpKTtcbiAgICAgICAgICBwYXJzaW5nID0gcGFyc2luZy5zdWJzdHJpbmcocGFyc2luZy5pbmRleE9mKFwiIFwiKSk7XG5cbiAgICAgICAgICBjb25zdCBtZXNzYWdlID0gcGFyc2luZy5zdWJzdHJpbmcoMCwgcGFyc2luZy5pbmRleE9mKFwiXFxuXCIpKTtcbiAgICAgICAgICBwYXJzaW5nID0gcGFyc2luZy5zdWJzdHJpbmcocGFyc2luZy5pbmRleE9mKFwiXFxuXCIpKTtcblxuICAgICAgICAgIGNvbnN0IFtmcCwgbGluZSwgY29sdW1uLCBfXSA9IGZpbGVBbmRXaGVyZS5zcGxpdChcIjpcIik7XG4gICAgICAgICAgZmlsZV9wYXRoID0gZnA7XG4gICAgICAgICAgbWVzc2FnZXMucHVzaCh7XG4gICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxuICAgICAgICAgICAgbGluZTogTnVtYmVyKGNvbHVtbikgLSAxLFxuICAgICAgICAgICAgY29sdW1uOiBOdW1iZXIobGluZSkgLSAxLFxuICAgICAgICAgICAgcnVsZUlkOiBudWxsLFxuICAgICAgICAgIH0gYXMgTGludE1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICAgIHJlc3VsdHMucHVzaCh7XG4gICAgICAgICAgZmlsZVBhdGg6IGZpbGVfcGF0aCxcbiAgICAgICAgICBtZXNzYWdlczogbWVzc2FnZXMsXG4gICAgICAgICAgZXJyb3JDb3VudDogbWVzc2FnZXMubGVuZ3RoLFxuICAgICAgICAgIGZhdGFsRXJyb3JDb3VudDogMCxcbiAgICAgICAgICB3YXJuaW5nQ291bnQ6IDAsXG4gICAgICAgICAgZml4YWJsZUVycm9yQ291bnQ6IDAsXG4gICAgICAgICAgZml4YWJsZVdhcm5pbmdDb3VudDogMCxcbiAgICAgICAgfSBhcyBMaW50UmVzdWx0KTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdHM7XG4gICAgICB9KTtcbiAgICAgIG5leHRfcmVhZHkgPSB0cnVlO1xuICAgIH1cbiAgICBydW5uaW5nID0gZmFsc2U7XG4gICAgY2hpbGQgPSBudWxsO1xuICAgIGNhbGxiYWNrKCk7XG4gICAgLy8gbm90aWZpY2F0aW9ucyBoYW5kbGVcbiAgICBpZiAobm90aWYudHlwZSA9PT0gXCJub25lXCIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKG5vdGlmLnR5cGUgPT09IFwiZGlzbWlzc2FibGVcIiAmJiBlcnIubGVuZ3RoICsgb3V0Lmxlbmd0aCA+IDApIHtcbiAgICAgIGFyZ3MuZGlzbWlzc2FibGUgPSB0cnVlO1xuICAgIH1cbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihydW5uZXIgKyBcIiBmYWlsZWRcIiwgYXJncyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRTdWNjZXNzKHJ1bm5lciArIFwiIHN1Y2Nlc3NmdWxcIiwgYXJncyk7XG4gICAgfVxuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByb3ZpZGVMaW50ZXIoKSB7XG4gIHJldHVybiB7XG4gICAgbmFtZTogXCJFc2xpbnRcIixcbiAgICBncmFtbWFyU2NvcGVzOiBbXCJzb3VyY2UudHNcIl0sXG4gICAgc2NvcGU6IFwiZmlsZVwiLFxuICAgIGxpbnRzT25DaGFuZ2U6IGZhbHNlLFxuICAgIGxpbnQ6IChlZGl0b3IpID0+IHtcbiAgICAgIGxldCBwcm9taXNlcyA9IFtdO1xuICAgICAgbGV0IHBhcnNpbmcgPSBjdXJyZW50X2Vycm9ycztcbiAgICAgIHdoaWxlIChwYXJzaW5nLmxlbmd0aCA+IDAgJiYgcGFyc2luZy5pbmRleE9mKFwiXFxuXCIpICE9PSAwKSB7XG4gICAgICAgIGNvbnN0IGZpbGVBbmRXaGVyZSA9IHBhcnNpbmcuc3Vic3RyaW5nKDAsIHBhcnNpbmcuaW5kZXhPZihcIiBcIikpO1xuICAgICAgICBwYXJzaW5nID0gcGFyc2luZy5zdWJzdHJpbmcocGFyc2luZy5pbmRleE9mKFwiIFwiKSk7XG5cbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IHBhcnNpbmcuc3Vic3RyaW5nKDAsIHBhcnNpbmcuaW5kZXhPZihcIlxcblwiKSk7XG4gICAgICAgIHBhcnNpbmcgPSBwYXJzaW5nLnN1YnN0cmluZyhwYXJzaW5nLmluZGV4T2YoXCJcXG5cIikpO1xuXG4gICAgICAgIGNvbnN0IFtwYXRoLCBsaW5lLCBjb2x1bW4sIGR1bW15XSA9IGZpbGVBbmRXaGVyZS5zcGxpdChcIjpcIik7XG5cbiAgICAgICAgcHJvbWlzZXMucHVzaCh7XG4gICAgICAgICAgc2V2ZXJpdHk6IFwiZXJyb3JcIixcbiAgICAgICAgICBleGNlcnB0OiBtZXNzYWdlLFxuICAgICAgICAgIGxvY2F0aW9uOiB7XG4gICAgICAgICAgICBmaWxlOiBwYXRoLFxuICAgICAgICAgICAgcG9zaXRpb246IGdlbmVyYXRlUmFuZ2UoZWRpdG9yLCBOdW1iZXIobGluZSkgLSAxLCBOdW1iZXIoY29sdW1uKSAtIDEpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShwcm9taXNlcyk7XG4gICAgfSxcbiAgfTtcbn1cblxuLy8gZXhwb3J0IGZ1bmN0aW9uIHByb3ZpZGVMaW50ZXIoKSB7XG4vLyAgIHJldHVybiB7XG4vLyAgICAgbmFtZTogXCJFc2xpbnRcIixcbi8vICAgICBncmFtbWFyU2NvcGVzOiBbXCJzb3VyY2UudHNcIl0sXG4vLyAgICAgc2NvcGU6IFwiZmlsZVwiLFxuLy8gICAgIGxpbnRzT25DaGFuZ2U6IGZhbHNlLFxuLy8gICAgIGxpbnQ6IGFzeW5jIChlZGl0b3IpID0+IHtcbi8vICAgICAgIG5leHRfcmVhZHkgPSBmYWxzZTtcbi8vICAgICAgIHN0YXJ0X3RpbWUgPSBEYXRlLm5vdygpO1xuLy8gICAgICAgY3VycmVudF9yZXN1bHRzLnRoZW4oYXN5bmMgKHJlc3VsdCkgPT4ge1xuLy8gICAgICAgICBhd2FpdCB3YWl0VG9SZWFkeSgpO1xuLy8gICAgICAgICByZXR1cm4gcmVzdWx0O1xuLy8gICAgICAgfSk7XG4vLyAgICAgICByZXR1cm4gYXdhaXQgY3VycmVudF9yZXN1bHRzXG4vLyAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiB7XG4vLyAgICAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBbXTtcbi8vICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdHMubGVuZ3RoOyArK2kpIHtcbi8vICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmVzdWx0c1tpXS5tZXNzYWdlcy5sZW5ndGg7ICsraikge1xuLy8gICAgICAgICAgICAgICBwcm9taXNlcy5wdXNoKHtcbi8vICAgICAgICAgICAgICAgICBzZXZlcml0eTogXCJlcnJvclwiLCAvLyByZXN1bHRzW2ldLm1lc3NhZ2VzW2pdLnNldmVyaXR5LFxuLy8gICAgICAgICAgICAgICAgIGV4Y2VycHQ6IHJlc3VsdHNbaV0ubWVzc2FnZXNbal0ubWVzc2FnZSxcbi8vICAgICAgICAgICAgICAgICBsb2NhdGlvbjoge1xuLy8gICAgICAgICAgICAgICAgICAgZmlsZTogcmVzdWx0c1tpXS5maWxlUGF0aCxcbi8vICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBnZW5lcmF0ZVJhbmdlKGVkaXRvciwgcmVzdWx0c1tpXS5tZXNzYWdlc1tqXS5saW5lLCByZXN1bHRzW2ldLm1lc3NhZ2VzW2pdLmNvbHVtbiksXG4vLyAgICAgICAgICAgICAgICAgfSxcbi8vICAgICAgICAgICAgICAgfSk7XG4vLyAgICAgICAgICAgICB9XG4vLyAgICAgICAgICAgfVxuLy8gICAgICAgICAgIGN1cnJlbnRfcmVzdWx0cyA9IG5ldyBQcm9taXNlKCgpID0+IHtcbi8vICAgICAgICAgICAgIHJldHVybiBbXTtcbi8vICAgICAgICAgICB9KTtcbi8vICAgICAgICAgICByZXR1cm4gcHJvbWlzZXM7XG4vLyAgICAgICAgIH0pXG4vLyAgICAgICAgIC5jYXRjaCgoZXJyb3I6IEVycm9yKSA9PiB7XG4vLyAgICAgICAgICAgbG9nTm90aWZpY2F0aW9uKFwiXCIsIFwiRVJST1I6IFwiICsgZXJyb3IubWVzc2FnZSk7XG4vLyAgICAgICAgIH0pO1xuLy8gICAgIH0sXG4vLyAgIH07XG4vLyB9XG4iXX0=